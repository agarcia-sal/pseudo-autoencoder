CLASS Solution  
    FUNCTION shortestPathAllKeys(grid)  
        SET directions TO list of pairs of zero and one zero and minus one one and zero minus one and zero  
        SET m TO the LENGTH OF grid  
        SET n TO the LENGTH OF element at position zero of grid  
        SET start TO none  
        SET num_keys TO zero  
          
        FOR i FROM zero TO m MINUS one  
            FOR j FROM zero TO n MINUS one  
                IF element at position i of grid IS EQUALS the character at position j  
                    IF character at position j EQUALS the character AT POSITION symbol at position corresponding to at sign  
                        SET start TO pair of i AND j  
                    ELSE IF character at position j IS LOWERCASE LETTER  
                        INCREMENT num_keys BY one  
                    END IF  
                END IF  
            END FOR  
        END FOR  
          
        SET queue TO a new double ended queue containing a tuple of element at position zero of start AND element at position one of start AND zero AND zero  
        SET visited TO a new set containing a tuple of element at position zero of start AND element at position one of start AND zero  
          
        WHILE queue is not empty  
            SET x, y, keys, steps TO the elements dequeued from the left of queue  
              
            FOR each dx, dy IN directions  
                SET nx TO x PLUS dx  
                SET ny TO y PLUS dy  
                  
                IF nx IS GREATER THAN OR EQUAL TO zero AND nx IS LESS THAN m AND ny IS GREATER THAN OR EQUAL TO zero AND ny IS LESS THAN n  
                    SET cell TO element at position nx of grid element at position ny  
                      
                    IF cell IS EQUALS wall symbol  
                        CONTINUE to next iteration  
                    END IF  
                      
                    IF cell IS UPPERCASE LETTER  
                        SET key_needed TO one SHIFTED LEFT BY the position of lowercase of cell MINUS position of letter a  
                        IF keys AND key_needed IS EQUALS zero  
                            CONTINUE to next iteration  
                        END IF  
                    END IF  
                      
                    IF cell IS LOWERCASE LETTER  
                        SET new_keys TO keys OR one SHIFTED LEFT BY the position of cell MINUS position of letter a  
                        IF new_keys IS EQUALS one SHIFTED LEFT BY num_keys MINUS one  
                            RETURN steps PLUS one  
                        END IF  
                    ELSE  
                        SET new_keys TO keys  
                    END IF  
                      
                    IF tuple of nx, ny, new_keys NOT IN visited  
                        ADD tuple of nx, ny, new_keys TO visited  
                        APPEND tuple of nx, ny, new_keys, steps PLUS one TO queue  
                    END IF  
                END IF  
            END FOR  
        END WHILE  
          
        RETURN minus one  
    END FUNCTION  
END CLASS