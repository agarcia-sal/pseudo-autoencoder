CLASS Solution  
    FUNCTION countOfAtoms(formula)  
        FUNCTION parse(segment)  
            SET atom_count TO a new map that returns zero for missing keys  
            SET elements TO all pairs of an element starting with a capital letter followed by zero or more lowercase letters AND a following number or empty string found in segment  
            FOR each element AND count IN elements  
                IF count IS NOT an empty string  
                    INCREMENT atom_count at element BY the integer value of count  
                ELSE  
                    INCREMENT atom_count at element BY one  
                END IF  
            END FOR  
            RETURN atom_count  
        END FUNCTION  
        
        FUNCTION multiply_counts(counts, multiplier)  
            FOR each element IN counts  
                SET counts at element TO counts at element MULTIPLIED BY multiplier  
            END FOR  
            RETURN counts  
        END FUNCTION  
        
        SET stack TO a list containing one new map that returns zero for missing keys  
        SET i TO zero  
        WHILE i LESS THAN the LENGTH OF formula  
            IF the element at position i of formula EQUALS an opening parenthesis  
                APPEND a new map that returns zero for missing keys TO stack  
                INCREMENT i BY one  
            ELSE IF the element at position i of formula EQUALS a closing parenthesis  
                SET segment_count TO a new map that returns zero for missing keys  
                SET j TO i PLUS one  
                WHILE j LESS THAN the LENGTH OF formula AND the element at position j of formula IS a digit  
                    INCREMENT j BY one  
                END WHILE  
                IF j GREATER THAN i PLUS one  
                    SET multiplier TO the integer value of the substring from position i PLUS one TO position j of formula  
                ELSE  
                    SET multiplier TO one  
                END IF  
                SET segment_count TO multiply_counts(the last element popped from stack, multiplier)  
                FOR each element IN segment_count  
                    INCREMENT the last element of stack at element BY segment_count at element  
                END FOR  
                SET i TO j  
            ELSE  
                SET j TO i PLUS one  
                WHILE j LESS THAN the LENGTH OF formula AND (the element at position j of formula IS a lowercase letter OR the element at position j of formula IS a digit)  
                    INCREMENT j BY one  
                END WHILE  
                SET segment_count TO parse(the substring from position i TO position j of formula)  
                FOR each element IN segment_count  
                    INCREMENT the last element of stack at element BY segment_count at element  
                END FOR  
                SET i TO j  
            END IF  
        END WHILE  
        
        SET final_count TO the last element popped from stack  
        SET result TO an empty string  
        FOR each element IN the sorted keys of final_count  
            APPEND element TO result  
            IF final_count at element GREATER THAN one  
                APPEND the string representation of final_count at element TO result  
            END IF  
        END FOR  
        RETURN result  
    END FUNCTION  
END CLASS