CLASS Term
    FUNCTION __init__(self, coefficient, variables)
        SET self.coefficient TO coefficient
        SET self.variables TO variables
    END FUNCTION

    FUNCTION __lt__(self, other)
        IF the LENGTH OF self.variables NOT EQUALS the LENGTH OF other.variables THEN
            RETURN whether the LENGTH OF self.variables IS GREATER THAN the LENGTH OF other.variables
        END IF
        RETURN whether the JOINED BY ASTERISK the LIST self.variables IS LESS THAN the JOINED BY ASTERISK the LIST other.variables
    END FUNCTION

    FUNCTION __repr__(self)
        IF the LIST self.variables IS EMPTY THEN
            RETURN the STRING REPRESENTATION OF self.coefficient
        END IF
        RETURN the STRING FORMED BY self.coefficient FOLLOWED BY ASTERISK FOLLOWED BY the JOINED BY ASTERISK the LIST self.variables
    END FUNCTION
END CLASS

CLASS Expression
    FUNCTION __init__(self)
        SET self.terms TO a DEFAULT DICTIONARY OF integer values
    END FUNCTION

    FUNCTION add_term(self, term)
        SET key TO a TUPLE OF the SORTED LIST term.variables
        INCREMENT the VALUE at key IN self.terms BY term.coefficient
    END FUNCTION

    FUNCTION multiply(self, other)
        ASSIGN result TO a NEW INSTANCE OF Expression
        FOR each vars1 AND coeff1 IN the ITEMS OF self.terms
            FOR each vars2 AND coeff2 IN the ITEMS OF other.terms
                SET combined_vars TO the SORTED LIST of the CONCATENATION OF LIST vars1 AND LIST vars2
                CALL add_term ON result WITH a NEW Term CREATED WITH the PRODUCT of coeff1 AND coeff2 AND combined_vars
            END FOR
        END FOR
        RETURN result
    END FUNCTION

    FUNCTION add(self, other)
        FOR each vars AND coeff IN the ITEMS OF other.terms
            CALL add_term ON self WITH a NEW Term CREATED WITH coeff AND the LIST vars
        END FOR
        RETURN self
    END FUNCTION

    FUNCTION subtract(self, other)
        FOR each vars AND coeff IN the ITEMS OF other.terms
            CALL add_term ON self WITH a NEW Term CREATED WITH the NEGATION OF coeff AND the LIST vars
        END FOR
        RETURN self
    END FUNCTION

    FUNCTION evaluate(self, var_map)
        ASSIGN result TO a NEW INSTANCE OF Expression
        FOR each vars AND coeff IN the ITEMS OF self.terms
            SET new_vars TO an EMPTY LIST
            FOR each var IN vars
                IF var IS IN var_map THEN
                    APPEND the STRING REPRESENTATION OF the VALUE AT var IN var_map TO new_vars
                ELSE
                    APPEND var TO new_vars
                END IF
            END FOR
            IF new_vars IS NOT EMPTY THEN
                SET new_coeff TO the EVALUATION OF the CONCATENATION OF ELEMENTS OF new_vars
            ELSE
                SET new_coeff TO one
            END IF
            CALL add_term ON result WITH a NEW Term CREATED WITH the PRODUCT OF coeff AND new_coeff AND an EMPTY LIST
        END FOR
        RETURN result
    END FUNCTION

    FUNCTION simplify(self)
        SET simplified_terms TO the LIST OF Term CREATED FOR each vars AND coeff IN the ITEMS OF self.terms WHERE coeff IS NOT ZERO, WITH coefficient coeff AND variables CONVERTED TO LIST FROM vars
        SORT simplified_terms USING THE __lt__ FUNCTION OF Term
        RETURN simplified_terms
    END FUNCTION

    FUNCTION __repr__(self)
        RETURN the STRING JOINED BY space PLUS space OF the STRING REPRESENTATION OF each term IN CALLING simplify ON self
    END FUNCTION
END CLASS

CLASS Solution
    FUNCTION basicCalculatorIV(self, expression, evalvars, evalints)
        SET var_map TO a DICTIONARY CREATED BY ZIPPING evalvars AND evalints
        SET tokens TO the LIST OF STRINGS FOUND BY REGULAR EXPRESSION MATCHING FOR ANY OF OPEN PARENTHESIS OR CLOSE PARENTHESIS OR PLUS OR MINUS OR ASTERISK OR ONE OR MORE DIGITS OR ONE OR MORE WORD CHARACTERS IN expression
        SET output TO an EMPTY LIST
        SET operators TO an EMPTY LIST

        FUNCTION apply_operator()
            SET right TO the LAST ELEMENT REMOVED FROM output
            SET left TO the LAST ELEMENT REMOVED FROM output
            SET op TO the LAST ELEMENT REMOVED FROM operators
            IF op EQUALS plus THEN
                APPEND the RESULT OF left ADD right TO output
            ELSE IF op EQUALS minus THEN
                APPEND the RESULT OF left SUBTRACT right TO output
            ELSE IF op EQUALS ASTERISK THEN
                APPEND the RESULT OF left MULTIPLY right TO output
            END IF
        END FUNCTION

        SET i TO zero
        WHILE i LESS THAN the LENGTH OF tokens HOLDS
            SET token TO the ELEMENT AT POSITION i OF tokens
            IF the token CONSISTS ONLY OF DIGIT CHARACTERS THEN
                APPEND a NEW Expression TO output
                CALL add_term ON the LAST ELEMENT OF output WITH a NEW Term CREATED WITH the INTEGER VALUE OF token AND an EMPTY LIST
            ELSE IF the token CONSISTS ONLY OF ALPHABETIC CHARACTERS THEN
                APPEND a NEW Expression TO output
                SET coef TO the VALUE FOR token IN var_map OR one IF NONE FOUND
                IF coef EQUALS one THEN
                    CALL add_term ON the LAST ELEMENT OF output WITH a NEW Term CREATED WITH one AND A LIST CONTAINING token ONLY IF token NOT IN var_map OTHERWISE AN EMPTY LIST
                ELSE
                    CALL add_term ON the LAST ELEMENT OF output WITH a NEW Term CREATED WITH coef AND an EMPTY LIST
                END IF
            ELSE IF token EQUALS an OPEN PARENTHESIS THEN
                APPEND token TO operators
            ELSE IF token EQUALS a CLOSE PARENTHESIS THEN
                WHILE operators IS NOT EMPTY AND THE LAST ELEMENT OF operators IS NOT AN OPEN PARENTHESIS HOLDS
                    CALL apply_operator
                END WHILE
                REMOVE the LAST ELEMENT FROM operators
            ELSE IF token IS ONE OF PLUS OR MINUS OR ASTERISK THEN
                WHILE operators IS NOT EMPTY AND THE LAST ELEMENT OF operators IS NOT AN OPEN PARENTHESIS AND
                      (token IS PLUS OR MINUS OR THE LAST ELEMENT OF operators IS ASTERISK) HOLDS
                    CALL apply_operator
                END WHILE
                APPEND token TO operators
            END IF
            INCREMENT i BY one
        END WHILE

        WHILE operators IS NOT EMPTY HOLDS
            CALL apply_operator
        END WHILE

        SET simplified_terms TO CALLING simplify ON the FIRST ELEMENT OF output
        RETURN a LIST CREATED BY FOR EACH term IN simplified_terms, FORMING A STRING THAT IS the STRING REPRESENTATION OF term.coefficient FOLLOWED BY ASTERISK FOLLOWED BY the JOINED BY ASTERISK the LIST term.variables IF term.variables IS NOT EMPTY OTHERWISE THE STRING REPRESENTATION OF term.coefficient
    END FUNCTION
END CLASS