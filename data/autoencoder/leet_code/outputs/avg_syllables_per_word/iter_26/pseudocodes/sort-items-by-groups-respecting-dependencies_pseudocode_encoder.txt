CLASS Solution
    FUNCTION sortItems(n, m, group, beforeItems)
        FOR index FROM zero TO n MINUS one INCLUSIVE
            IF element at position index OF group EQUALS negation of one
                SET element at position index OF group TO m
                INCREMENT m BY one
            END IF
        END FOR

        ASSIGN reference TO a new default dictionary of lists named group_items
        ASSIGN reference TO a new default dictionary of lists named group_graph
        ASSIGN reference TO a new default dictionary of lists named item_graph
        SET item_in_degree TO a list of zero repeated n times
        SET group_in_degree TO a list of zero repeated m times

        FOR index FROM zero TO n MINUS one INCLUSIVE
            APPEND index TO the list at key element at position index OF group IN group_items
        END FOR

        FOR index FROM zero TO n MINUS one INCLUSIVE
            FOR each element before IN element at position index OF beforeItems
                IF element at position before OF group EQUALS element at position index OF group
                    APPEND index TO the list at key before IN item_graph
                    INCREMENT element at position index OF item_in_degree BY one
                ELSE
                    APPEND element at position index OF group TO the list at key element at position before OF group IN group_graph
                    INCREMENT element at position element at position index OF group OF group_in_degree BY one
                END IF
            END FOR
        END FOR

        FUNCTION topological_sort(graph, in_degree, items)
            ASSIGN reference TO a new deque containing each item IN items WHERE element at position item OF in_degree EQUALS zero
            SET result TO an empty list

            WHILE the deque is not empty
                REMOVE the element from the left of the deque AND ASSIGN to u
                APPEND u TO result
                FOR each element v IN the list at key u IN graph
                    DECREMENT element at position v OF in_degree BY one
                    IF element at position v OF in_degree EQUALS zero
                        APPEND v TO the deque
                    END IF
                END FOR
            END WHILE

            IF the LENGTH OF result EQUALS the LENGTH OF items
                RETURN result
            ELSE
                RETURN an empty list
            END IF
        END FUNCTION

        SET sorted_within_groups TO an empty list
        FOR each items IN the values of group_items
            SET sorted_items TO the result of calling topological_sort with arguments item_graph, item_in_degree, items
            IF sorted_items IS empty
                RETURN an empty list
            END IF
            APPEND all elements of sorted_items TO sorted_within_groups
        END FOR

        SET sorted_groups TO the result of calling topological_sort with arguments group_graph, group_in_degree, the list of integers from zero TO m MINUS one inclusive
        IF sorted_groups IS empty
            RETURN an empty list
        END IF

        ASSIGN reference TO a new default dictionary of lists named group_to_items_map
        FOR each item IN sorted_within_groups
            APPEND item TO the list at key element at position item OF group IN group_to_items_map
        END FOR

        SET result TO an empty list
        FOR each group IN sorted_groups
            APPEND all elements of the list at key group IN group_to_items_map TO result
        END FOR

        RETURN result
    END FUNCTION
END CLASS