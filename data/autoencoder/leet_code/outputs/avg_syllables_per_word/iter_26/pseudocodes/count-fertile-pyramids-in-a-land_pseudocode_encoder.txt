CLASS Solution
    FUNCTION countPyramids(grid)
        FUNCTION count_pyramids_from_top(grid)
            IF grid IS empty OR element at position zero OF grid IS empty
                RETURN zero
            END IF
            SET m TO the LENGTH OF grid
            SET n TO the LENGTH OF element at position zero OF grid
            SET dp TO a new list containing m elements each being a list containing n elements each set to zero
            SET count TO zero

            FOR i FROM zero TO m MINUS one INCLUSIVE
                FOR j FROM zero TO n MINUS one INCLUSIVE
                    IF element at position i OF grid at position j EQUALS one
                        IF i EQUALS zero OR j EQUALS zero OR j EQUALS n MINUS one
                            SET element at position i OF dp at position j TO one
                        ELSE
                            SET element at position i OF dp at position j TO the MINIMUM OF element at position i MINUS one OF dp at position j MINUS one, element at position i MINUS one OF dp at position j, AND element at position i MINUS one OF dp at position j PLUS one PLUS one
                        END IF
                        IF element at position i OF dp at position j GREATER THAN one
                            INCREMENT count BY element at position i OF dp at position j MINUS one
                        END IF
                    END IF
                END FOR
            END FOR

            RETURN count
        END FUNCTION

        FUNCTION count_pyramids_from_bottom(grid)
            IF grid IS empty OR element at position zero OF grid IS empty
                RETURN zero
            END IF
            SET m TO the LENGTH OF grid
            SET n TO the LENGTH OF element at position zero OF grid
            SET dp TO a new list containing m elements each being a list containing n elements each set to zero
            SET count TO zero

            FOR i FROM m MINUS one TO zero STEP negative one
                FOR j FROM zero TO n MINUS one INCLUSIVE
                    IF element at position i OF grid at position j EQUALS one
                        IF i EQUALS m MINUS one OR j EQUALS zero OR j EQUALS n MINUS one
                            SET element at position i OF dp at position j TO one
                        ELSE
                            SET element at position i OF dp at position j TO the MINIMUM OF element at position i PLUS one OF dp at position j MINUS one, element at position i PLUS one OF dp at position j, AND element at position i PLUS one OF dp at position j PLUS one PLUS one
                        END IF
                        IF element at position i OF dp at position j GREATER THAN one
                            INCREMENT count BY element at position i OF dp at position j MINUS one
                        END IF
                    END IF
                END FOR
            END FOR

            RETURN count
        END FUNCTION

        RETURN the RESULT OF count_pyramids_from_top WITH grid PLUS the RESULT OF count_pyramids_from_bottom WITH grid
    END FUNCTION
END CLASS