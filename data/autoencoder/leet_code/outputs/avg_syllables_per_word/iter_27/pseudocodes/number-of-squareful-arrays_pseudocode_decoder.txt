CLASS Solution  
    FUNCTION numSquarefulPerms(nums)  
        FUNCTION is_square(n)  
            SET root TO the integer square root of n  
            IF root MULTIPLIED BY root EQUALS n  
                RETURN true  
            ELSE  
                RETURN false  
            END IF  
        END FUNCTION  

        FUNCTION backtrack(path, count)  
            IF the LENGTH OF path EQUALS the LENGTH OF nums  
                RETURN one  
            END IF  

            SET ans TO zero  
            FOR each element x IN the keys of count  
                IF the value at x in count GREATER THAN zero AND (the LENGTH OF path EQUALS zero OR is_square(the last element of path PLUS x))  
                    DECREMENT the value at x in count BY one  
                    SET ans TO ans PLUS backtrack(path APPENDED WITH x, count)  
                    INCREMENT the value at x in count BY one  
                END IF  
            END FOR  
            RETURN ans  
        END FUNCTION  

        SET count TO a mapping from elements of nums to their frequencies  
        RETURN backtrack(an empty list, count)  
    END FUNCTION  
END CLASS