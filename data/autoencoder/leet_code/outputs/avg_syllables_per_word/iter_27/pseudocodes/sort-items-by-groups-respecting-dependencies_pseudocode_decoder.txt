CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR index_i FROM zero TO n MINUS one  
            IF element at position index_i of group EQUALS negative one  
                SET element at position index_i of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        ASSIGN reference TO a new mapping from integer TO list called group_items with default empty list  
        ASSIGN reference TO a new mapping from integer TO list called group_graph with default empty list  
        ASSIGN reference TO a new mapping from integer TO list called item_graph with default empty list  
        SET item_in_degree TO a list of zeros with length n  
        SET group_in_degree TO a list of zeros with length m  
        
        FOR index_i FROM zero TO n MINUS one  
            APPEND index_i TO the list at key element at position index_i of group in group_items  
        END FOR  
        
        FOR index_i FROM zero TO n MINUS one  
            FOR each element before IN element at position index_i of beforeItems  
                IF element at position before of group EQUALS element at position index_i of group  
                    APPEND index_i TO the list at key before in item_graph  
                    INCREMENT element at position index_i of item_in_degree BY one  
                ELSE  
                    APPEND element at position index_i of group TO the list at key element at position before of group in group_graph  
                    INCREMENT element at position element at position index_i of group of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            ASSIGN reference TO a new deque q initialized with elements from items WHERE element at position of in_degree EQUALS zero  
            SET result TO an empty list  
            WHILE q is not empty  
                REMOVE leftmost element FROM q AND ASSIGN TO u  
                APPEND u TO result  
                FOR each element v IN list at key u in graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO q  
                    END IF  
                END FOR  
            END WHILE  
            IF LENGTH of result EQUALS LENGTH of items  
                RETURN result  
            ELSE  
                RETURN an empty list  
            END IF  
        END FUNCTION  
        
        SET sorted_within_groups TO an empty list  
        FOR each list items IN values of group_items  
            SET sorted_items TO topological_sort(item_graph, item_in_degree, items)  
            IF LENGTH of sorted_items EQUALS zero  
                RETURN an empty list  
            END IF  
            EXTEND sorted_within_groups BY elements of sorted_items  
        END FOR  
        
        SET sorted_groups TO topological_sort(group_graph, group_in_degree, list of integers from zero TO m MINUS one)  
        IF LENGTH of sorted_groups EQUALS zero  
            RETURN an empty list  
        END IF  
        
        ASSIGN reference TO a new mapping from integer TO list called group_to_items_map with default empty list  
        FOR each element item IN sorted_within_groups  
            APPEND item TO the list at key element at position item of group in group_to_items_map  
        END FOR  
        
        SET result TO an empty list  
        FOR each element group_key IN sorted_groups  
            EXTEND result BY elements of list at key group_key in group_to_items_map  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS