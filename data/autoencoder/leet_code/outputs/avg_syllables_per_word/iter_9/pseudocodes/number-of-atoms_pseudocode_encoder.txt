CLASS Solution  
    FUNCTION countOfAtoms(self, formula)  
        FUNCTION parse(segment)  
            SET atom_count TO new empty mapping from element to integer  
            SET elements TO list of pairs found in segment matching pattern of uppercase letter followed by zero or more lowercase letters and zero or more digits  
            FOR each element, count IN elements  
                IF count is not empty THEN  
                    INCREMENT atom_count[element] BY integer value of count  
                ELSE  
                    INCREMENT atom_count[element] BY one  
                END IF  
            END FOR  
            RETURN atom_count  
        END FUNCTION  
        
        FUNCTION multiply_counts(counts, multiplier)  
            FOR each element IN counts  
                SET counts[element] TO counts[element] MULTIPLIED BY multiplier  
            END FOR  
            RETURN counts  
        END FUNCTION  
        
        SET stack TO list containing one new empty mapping from element to integer  
        SET i TO zero  
        WHILE i LESS THAN length of formula DO  
            IF character at formula position i EQUALS open parenthesis THEN  
                APPEND new empty mapping from element to integer TO stack  
                INCREMENT i BY one  
            ELSE IF character at formula position i EQUALS close parenthesis THEN  
                SET j TO i PLUS one  
                WHILE j LESS THAN length of formula AND character at formula position j IS a digit DO  
                    INCREMENT j BY one  
                END WHILE  
                IF j GREATER THAN i PLUS one THEN  
                    SET multiplier TO integer value of substring of formula from position i plus one to j  
                ELSE  
                    SET multiplier TO one  
                END IF  
                SET segment_count TO multiply_counts(pop last mapping FROM stack, multiplier)  
                FOR each element IN segment_count  
                    INCREMENT stack's last mapping at element BY segment_count[element]  
                END FOR  
                SET i TO j  
            ELSE  
                SET j TO i PLUS one  
                WHILE j LESS THAN length of formula AND (character at formula position j IS lowercase letter OR character at formula position j IS digit) DO  
                    INCREMENT j BY one  
                END WHILE  
                SET segment_count TO parse(substring of formula from position i to j)  
                FOR each element IN segment_count  
                    INCREMENT stack's last mapping at element BY segment_count[element]  
                END FOR  
                SET i TO j  
            END IF  
        END WHILE  
        
        SET final_count TO pop last mapping FROM stack  
        SET result TO empty string  
        FOR each element IN elements of final_count sorted in ascending order DO  
            APPEND element TO result  
            IF final_count[element] GREATER THAN one THEN  
                APPEND string value of final_count[element] TO result  
            END IF  
        END FOR  
        RETURN result  
    END FUNCTION  
END CLASS