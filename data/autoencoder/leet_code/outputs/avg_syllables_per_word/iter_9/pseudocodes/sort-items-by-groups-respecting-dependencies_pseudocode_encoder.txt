CLASS Solution  
    FUNCTION sortItems(self, n, m, group, beforeItems)  
        FOR i FROM zero TO n MINUS one  
            IF group at index i EQUALS minus one THEN  
                SET group at index i TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        SET group_items TO new mapping from group to empty list  
        SET group_graph TO new mapping from group to empty list  
        SET item_graph TO new mapping from item to empty list  
        SET item_in_degree TO list of zeros with length n  
        SET group_in_degree TO list of zeros with length m  
        
        FOR i FROM zero TO n MINUS one  
            APPEND i TO group_items at key group at index i  
        END FOR  
        
        FOR i FROM zero TO n MINUS one  
            FOR each before IN beforeItems at index i  
                IF group at index before EQUALS group at index i THEN  
                    APPEND i TO item_graph at key before  
                    INCREMENT item_in_degree at index i BY one  
                ELSE  
                    APPEND group at index i TO group_graph at key group at index before  
                    INCREMENT group_in_degree at index group at index i BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET q TO a new double-ended queue containing elements from items where in_degree of element EQUALS zero  
            SET result TO empty list  
            WHILE q is not empty  
                REMOVE first element FROM q and assign to u  
                APPEND u TO result  
                FOR each v IN graph at key u  
                    DECREMENT in_degree at index v BY one  
                    IF in_degree at index v EQUALS zero THEN  
                        APPEND v TO q  
                    END IF  
                END FOR  
            END WHILE  
            IF length of result EQUALS length of items THEN  
                RETURN result  
            ELSE  
                RETURN empty list  
            END IF  
        END FUNCTION  
        
        SET sorted_within_groups TO empty list  
        FOR each items IN values of group_items  
            SET sorted_items TO topological_sort(item_graph, item_in_degree, items)  
            IF sorted_items IS empty THEN  
                RETURN empty list  
            END IF  
            EXTEND sorted_within_groups BY sorted_items  
        END FOR  
        
        SET sorted_groups TO topological_sort(group_graph, group_in_degree, list of integers from zero TO m MINUS one)  
        IF sorted_groups IS empty THEN  
            RETURN empty list  
        END IF  
        
        SET group_to_items_map TO new mapping from group to empty list  
        FOR each item IN sorted_within_groups  
            APPEND item TO group_to_items_map at key group at index item  
        END FOR  
        
        SET result TO empty list  
        FOR each group_key IN sorted_groups  
            EXTEND result BY group_to_items_map at key group_key  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS