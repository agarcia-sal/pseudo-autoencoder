CLASS Solution  
    FUNCTION countCombinations(self, pieces, positions)  
        SET directions TO  
            "rook" MAPPED TO list containing  
                pair of one AND zero,  
                pair of negative one AND zero,  
                pair of zero AND one,  
                pair of zero AND negative one  
            "queen" MAPPED TO list containing  
                pair of one AND zero,  
                pair of negative one AND zero,  
                pair of zero AND one,  
                pair of zero AND negative one,  
                pair of one AND one,  
                pair of negative one AND one,  
                pair of one AND negative one,  
                pair of negative one AND negative one  
            "bishop" MAPPED TO list containing  
                pair of one AND one,  
                pair of negative one AND one,  
                pair of one AND negative one,  
                pair of negative one AND negative one  
        SET positions TO new list constructed by  
            FOR each pair r, c IN positions  
                SET element TO pair of r MINUS one AND c MINUS one  
        
        FUNCTION get_destinations(start, piece_type)  
            SET r TO first element of start  
            SET c TO second element of start  
            SET dests TO list containing start  
            FOR each pair dr, dc IN directions MAPPED BY piece_type  
                SET nr TO r PLUS dr  
                SET nc TO c PLUS dc  
                WHILE nr GREATER THAN OR EQUAL TO zero AND nr LESS THAN eight AND nc GREATER THAN OR EQUAL TO zero AND nc LESS THAN eight DO  
                    APPEND pair of nr AND nc TO dests  
                    SET nr TO nr PLUS dr  
                    SET nc TO nc PLUS dc  
                END WHILE  
            END FOR  
            RETURN dests  
        END FUNCTION  
        
        SET all_destinations TO new list constructed by  
            FOR each position pos AND piece IN pairs of positions AND pieces  
                SET element TO result of get_destinations(pos, piece)  
        
        FUNCTION is_valid_combination(combination)  
            SET pos TO copy of positions  
            SET n TO length of pos  
            WHILE true DO  
                IF length of set constructed from pos LESS THAN n THEN  
                    RETURN false  
                END IF  
                SET all_reached TO true  
                FOR i FROM zero TO n MINUS one DO  
                    IF pos AT i EQUALS combination AT i THEN  
                        CONTINUE to next iteration  
                    END IF  
                    SET all_reached TO false  
                    SET r TO first element of pos AT i  
                    SET c TO second element of pos AT i  
                    IF first element of combination AT i GREATER THAN r THEN  
                        SET dr TO one  
                    ELSE IF first element of combination AT i LESS THAN r THEN  
                        SET dr TO negative one  
                    ELSE  
                        SET dr TO zero  
                    END IF  
                    IF second element of combination AT i GREATER THAN c THEN  
                        SET dc TO one  
                    ELSE IF second element of combination AT i LESS THAN c THEN  
                        SET dc TO negative one  
                    ELSE  
                        SET dc TO zero  
                    END IF  
                    SET pos AT i TO pair of r PLUS dr AND c PLUS dc  
                END FOR  
                IF all_reached THEN  
                    RETURN true  
                END IF  
            END WHILE  
        END FUNCTION  
        
        SET valid_count TO zero  
        FOR each combination IN cartesian product of all elements in all_destinations DO  
            IF is_valid_combination(combination) THEN  
                INCREMENT valid_count BY one  
            END IF  
        END FOR  
        
        RETURN valid_count  
    END FUNCTION  
END CLASS