CLASS Solution
    FUNCTION removeBoxes(boxes: List of Integer) RETURNS Integer
        FUNCTION dp(l, r, k, memo) RETURNS Integer
            IF l > r THEN
                RETURN 0
            END IF
            IF (l, r, k) IN memo THEN
                RETURN memo[(l, r, k)]
            END IF

            WHILE r > l AND boxes[r] EQUALS boxes[r - 1] DO
                DECREMENT r BY 1
                INCREMENT k BY 1
            END WHILE

            SET res TO dp(l, r - 1, 0, memo) PLUS (k + 1) TIMES (k + 1)

            FOR i FROM l TO r - 1 DO
                IF boxes[i] EQUALS boxes[r] THEN
                    SET candidate TO dp(l, i, k + 1, memo) PLUS dp(i + 1, r - 1, 0, memo)
                    SET res TO MAXIMUM OF res AND candidate
                END IF
            END FOR

            SET memo[(l, r, k)] TO res
            RETURN res
        END FUNCTION

        RETURN dp(0, LENGTH OF boxes MINUS 1, 0, EMPTY MAP)
    END FUNCTION
END CLASS