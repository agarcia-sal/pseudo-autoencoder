CLASS Solution  
    FUNCTION countOfAtoms(formula)  
        FUNCTION parse(segment)  
            SET atom_count TO a new default dictionary with integer default  
            SET elements TO all matches of a pattern with one uppercase letter followed by zero or more lowercase letters and zero or more digits in segment  
            FOR each element and count IN elements  
                IF count IS NOT empty string  
                    INCREMENT atom_count at element BY integer value of count  
                ELSE  
                    INCREMENT atom_count at element BY one  
                END IF  
            END FOR  
            RETURN atom_count  
        END FUNCTION  
  
        FUNCTION multiply_counts(counts, multiplier)  
            FOR each element IN counts  
                SET counts at element TO counts at element MULTIPLIED BY multiplier  
            END FOR  
            RETURN counts  
        END FUNCTION  
  
        SET stack TO a list containing one new default dictionary with integer default  
        SET i TO zero  
  
        WHILE i LESS THAN length of formula  
            IF element at position i of formula EQUALS opening parenthesis  
                APPEND a new default dictionary with integer default TO stack  
                INCREMENT i BY one  
            ELSE IF element at position i of formula EQUALS closing parenthesis  
                SET segment_count TO a new default dictionary with integer default  
                SET j TO i PLUS one  
                WHILE j LESS THAN length of formula AND element at position j of formula IS a digit  
                    INCREMENT j BY one  
                END WHILE  
                IF j GREATER THAN i PLUS one  
                    SET multiplier TO integer conversion of formula substring from i plus one to j  
                ELSE  
                    SET multiplier TO one  
                END IF  
                SET segment_count TO result of multiply_counts of popping last dictionary from stack AND multiplier  
                FOR each element IN segment_count  
                    INCREMENT element count in last dictionary in stack BY segment_count at element  
                END FOR  
                SET i TO j  
            ELSE  
                SET j TO i PLUS one  
                WHILE j LESS THAN length of formula AND (element at position j of formula IS a lowercase letter OR IS a digit)  
                    INCREMENT j BY one  
                END WHILE  
                SET segment_count TO parse of formula substring from i to j  
                FOR each element IN segment_count  
                    INCREMENT element count in last dictionary in stack BY segment_count at element  
                END FOR  
                SET i TO j  
            END IF  
        END WHILE  
  
        SET final_count TO popping last dictionary from stack  
        RETURN concatenation for each element in sorted keys of final_count of element PLUS (string of final_count at element IF final_count at element GREATER THAN one ELSE empty string)  
    END FUNCTION  
END CLASS