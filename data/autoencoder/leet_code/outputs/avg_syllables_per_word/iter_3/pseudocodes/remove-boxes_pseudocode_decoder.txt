CLASS Solution
    FUNCTION removeBoxes(boxes: List of Integer) RETURNS Integer
        FUNCTION dp(l, r, k, memo)
            IF l > r THEN
                RETURN 0
            IF (l, r, k) EXISTS IN memo THEN
                RETURN memo[(l, r, k)]

            WHILE r > l AND boxes[r] EQUALS boxes[r - 1] DO
                DECREMENT r BY 1
                INCREMENT k BY 1

            SET res TO dp(l, r - 1, 0, memo) PLUS (k + 1) TIMES (k + 1)

            FOR i FROM l TO r - 1 DO
                IF boxes[i] EQUALS boxes[r] THEN
                    SET res TO MAXIMUM OF res AND dp(l, i, k + 1, memo) PLUS dp(i + 1, r - 1, 0, memo)

            SET memo[(l, r, k)] TO res
            RETURN res
        END FUNCTION

        RETURN dp(0, LENGTH OF boxes MINUS 1, 0, EMPTY DICTIONARY)
    END FUNCTION
END CLASS