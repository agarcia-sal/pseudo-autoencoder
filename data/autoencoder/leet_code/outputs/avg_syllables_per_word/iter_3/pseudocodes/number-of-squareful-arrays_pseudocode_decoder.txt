CLASS Solution
    FUNCTION numSquarefulPerms(nums)
        FUNCTION is_square(n)
            SET root TO integer square root of n
            RETURN root times root EQUALS n
        END FUNCTION

        FUNCTION backtrack(path, count)
            IF LENGTH OF path EQUALS LENGTH OF nums THEN
                RETURN 1
            END IF

            SET ans TO 0
            FOR each x IN keys of count DO
                IF count[x] GREATER THAN 0 AND (path IS EMPTY OR is_square(last element of path PLUS x)) THEN
                    DECREMENT count[x] BY 1
                    SET ans TO ans PLUS backtrack(path APPENDED WITH x, count)
                    INCREMENT count[x] BY 1
                END IF
            END FOR
            RETURN ans
        END FUNCTION

        SET count TO frequency count of elements in nums
        RETURN backtrack(empty list, count)
    END FUNCTION
END CLASS