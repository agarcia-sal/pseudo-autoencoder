CLASS Solution  
    FUNCTION numSquarefulPerms(nums)  
        FUNCTION is_square(n)  
            SET root TO integer square root of n  
            RETURN root multiplied BY root EQUALS n  
        END FUNCTION  
  
        FUNCTION backtrack(path, count)  
            IF length of path EQUALS length of nums THEN  
                RETURN 1  
            END IF  
  
            SET ans TO 0  
            FOR each x IN keys of count DO  
                IF count[x] GREATER THAN 0 AND (path IS empty OR is_square(last element of path PLUS x)) THEN  
                    DECREMENT count[x] BY 1  
                    SET ans TO ans PLUS backtrack(path WITH x appended, count)  
                    INCREMENT count[x] BY 1  
                END IF  
            END FOR  
            RETURN ans  
        END FUNCTION  
  
        SET count TO frequency map of nums  
        RETURN backtrack(empty list, count)  
    END FUNCTION  
END CLASS