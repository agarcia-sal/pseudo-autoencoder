CLASS Solution  
    FUNCTION shortestPathAllKeys(grid)  
        SET directions TO list of (0, 1), (0, -1), (1, 0), (-1, 0)  
  
        SET m TO LENGTH OF grid  
        SET n TO LENGTH OF grid AT 0  
        SET start TO None  
        SET num_keys TO 0  
  
        FOR i FROM 0 TO m MINUS 1  
            FOR j FROM 0 TO n MINUS 1  
                IF grid AT i AT j EQUALS '@'  
                    SET start TO tuple of i, j  
                ELSE IF grid AT i AT j IS LOWERCASE LETTER  
                    INCREMENT num_keys BY 1  
  
        INITIALIZE queue AS deque WITH tuple of start AT 0, start AT 1, 0, 0  
        INITIALIZE visited AS set CONTAINING tuple of start AT 0, start AT 1, 0  
  
        WHILE queue IS NOT EMPTY  
            REMOVE FIRST ELEMENT FROM queue AND UNPACK INTO x, y, keys, steps  
              
            FOR EACH dx, dy IN directions  
                SET nx TO x PLUS dx  
                SET ny TO y PLUS dy  
                
                IF nx IS GREATER THAN OR EQUAL TO 0 AND nx IS LESS THAN m AND ny IS GREATER THAN OR EQUAL TO 0 AND ny IS LESS THAN n  
                    SET cell TO grid AT nx AT ny  
                    
                    IF cell EQUALS '#'  
                        CONTINUE TO NEXT ITERATION  
                    
                    IF cell IS UPPERCASE LETTER  
                        SET key_needed TO 1 LEFT SHIFTED BY (ASCII VALUE OF LOWERCASE OF cell MINUS ASCII VALUE OF 'a')  
                        IF keys BITWISE AND key_needed EQUALS 0  
                            CONTINUE TO NEXT ITERATION  
                    
                    IF cell IS LOWERCASE LETTER  
                        SET new_keys TO keys BITWISE OR (1 LEFT SHIFTED BY (ASCII VALUE OF cell MINUS ASCII VALUE OF 'a'))  
                        IF new_keys EQUALS (1 LEFT SHIFTED BY num_keys) MINUS 1  
                            RETURN steps PLUS 1  
                    ELSE  
                        SET new_keys TO keys  
                    
                    IF tuple of nx, ny, new_keys IS NOT IN visited  
                        ADD tuple of nx, ny, new_keys TO visited  
                        APPEND tuple of nx, ny, new_keys, steps PLUS 1 TO queue  
  
        RETURN -1  
    END FUNCTION  
END CLASS