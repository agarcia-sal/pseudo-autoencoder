CLASS Solution  
    FUNCTION countPyramids(grid)  
        FUNCTION count_pyramids_from_top(grid)  
            IF grid IS EMPTY OR first row of grid IS EMPTY  
                RETURN 0  
            SET m TO number of rows in grid  
            SET n TO number of columns in grid  
            INITIALIZE dp AS a two-dimensional list of zeros with dimensions m by n  
            SET count TO 0  
            
            FOR i FROM 0 TO m MINUS 1  
                FOR j FROM 0 TO n MINUS 1  
                    IF grid at position i, j EQUALS 1  
                        IF i EQUALS 0 OR j EQUALS 0 OR j EQUALS n MINUS 1  
                            SET dp at position i, j TO 1  
                        ELSE  
                            SET dp at position i, j TO minimum of dp at positions (i MINUS 1, j MINUS 1), (i MINUS 1, j), and (i MINUS 1, j PLUS 1) PLUS 1  
                        IF dp at position i, j GREATER THAN 1  
                            INCREMENT count BY dp at position i, j MINUS 1  
            
            RETURN count  
        END FUNCTION  
        
        FUNCTION count_pyramids_from_bottom(grid)  
            IF grid IS EMPTY OR first row of grid IS EMPTY  
                RETURN 0  
            SET m TO number of rows in grid  
            SET n TO number of columns in grid  
            INITIALIZE dp AS a two-dimensional list of zeros with dimensions m by n  
            SET count TO 0  
            
            FOR i FROM m MINUS 1 DOWN TO 0  
                FOR j FROM 0 TO n MINUS 1  
                    IF grid at position i, j EQUALS 1  
                        IF i EQUALS m MINUS 1 OR j EQUALS 0 OR j EQUALS n MINUS 1  
                            SET dp at position i, j TO 1  
                        ELSE  
                            SET dp at position i, j TO minimum of dp at positions (i PLUS 1, j MINUS 1), (i PLUS 1, j), and (i PLUS 1, j PLUS 1) PLUS 1  
                        IF dp at position i, j GREATER THAN 1  
                            INCREMENT count BY dp at position i, j MINUS 1  
            
            RETURN count  
        END FUNCTION  
        
        RETURN count_pyramids_from_top(grid) PLUS count_pyramids_from_bottom(grid)  
    END FUNCTION  
END CLASS