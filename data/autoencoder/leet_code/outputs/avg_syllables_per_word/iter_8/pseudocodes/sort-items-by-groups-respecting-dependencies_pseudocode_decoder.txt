CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR i FROM 0 TO n MINUS 1  
            IF group AT i EQUALS -1 THEN  
                SET group AT i TO m  
                INCREMENT m BY 1  
        
        SET group_items TO a new mapping with default empty list  
        SET group_graph TO a new mapping with default empty list  
        SET item_graph TO a new mapping with default empty list  
        SET item_in_degree TO a list of zeros of length n  
        SET group_in_degree TO a list of zeros of length m  
        
        FOR i FROM 0 TO n MINUS 1  
            APPEND i TO group_items AT group AT i  
        
        FOR i FROM 0 TO n MINUS 1  
            FOR each before IN beforeItems AT i  
                IF group AT before EQUALS group AT i THEN  
                    APPEND i TO item_graph AT before  
                    INCREMENT item_in_degree AT i BY 1  
                ELSE  
                    APPEND group AT i TO group_graph AT group AT before  
                    INCREMENT group_in_degree AT group AT i BY 1  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET queue TO a new deque of items where in_degree AT item EQUALS 0  
            SET result TO an empty list  
            WHILE queue is not empty  
                SET u TO REMOVE first element from queue  
                APPEND u TO result  
                FOR each v IN graph AT u  
                    DECREMENT in_degree AT v BY 1  
                    IF in_degree AT v EQUALS 0 THEN  
                        APPEND v TO queue  
            IF LENGTH OF result EQUALS LENGTH OF items THEN  
                RETURN result  
            ELSE  
                RETURN an empty list  
        
        SET sorted_within_groups TO an empty list  
        FOR each items IN group_items VALUES  
            SET sorted_items TO topological_sort(item_graph, item_in_degree, items)  
            IF sorted_items IS empty THEN  
                RETURN empty list  
            EXTEND sorted_within_groups BY sorted_items  
        
        SET sorted_groups TO topological_sort(group_graph, group_in_degree, list FROM 0 TO m MINUS 1)  
        IF sorted_groups IS empty THEN  
            RETURN empty list  
        
        SET group_to_items_map TO a new mapping with default empty list  
        FOR each item IN sorted_within_groups  
            APPEND item TO group_to_items_map AT group AT item  
        
        SET result TO an empty list  
        FOR each group IN sorted_groups  
            EXTEND result BY group_to_items_map AT group  
        
        RETURN result  
    END FUNCTION  
END CLASS