```
n = len(parents)
tree = defaultdict(list)
for i in 1..n-1: tree[parents[i]].append(i)

node_with_one = first i where nums[i] == 1 else -1
if node_with_one == -1: return [1]*n

result = [1]*n
visited = set()

dfs(node):
    visited.add(node)
    vals = {nums[node]}
    for c in tree[node]:
        if c not in visited: vals |= dfs(c)
    miss = 1
    while miss in vals: miss += 1
    result[node] = miss
    return vals

path = []
cur = node_with_one
while cur != -1:
    path.append(cur)
    cur = parents[cur]

for node in reversed(path):
    if node not in visited: dfs(node)

return result
```