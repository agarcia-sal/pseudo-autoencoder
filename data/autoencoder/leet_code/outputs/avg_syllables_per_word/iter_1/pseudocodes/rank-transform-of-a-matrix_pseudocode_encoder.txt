```
m, n ← dims(matrix)
value_to_indices ← map val → list of (r,c) where matrix[r][c] = val

row_rank ← [0]*m
col_rank ← [0]*n
result ← zero m×n matrix

for value in sorted keys of value_to_indices:
    uf ← UnionFind(m+n)
    rank_map ← map root → int

    for (r,c) in value_to_indices[value]:
        uf.union(r, c+m)

    for (r,c) in value_to_indices[value]:
        root ← uf.find(r)
        rank_map[root] ← max(rank_map[root], max(row_rank[r], col_rank[c]) + 1)

    for (r,c) in value_to_indices[value]:
        root ← uf.find(r)
        result[r][c] ← rank_map[root]
        row_rank[r] ← rank_map[root]
        col_rank[c] ← rank_map[root]

return result
```