```
init count, freq as empty freq counters
max_len = 0
for i, num in enumerate(nums):
    increment count[num]
    if count[num] > 1:
        decrement freq[count[num]-1]
        if freq[count[num]-1] == 0: remove freq[count[num]-1]
    increment freq[count[num]]
    if (len(freq)==1 and (1 in freq or freq.values()==[1])) or
       (len(freq)==2 and ((freq[1] == 1) or ((max(freq)-min(freq) == 1) and freq[max(freq)] == 1))):
        max_len = i + 1
return max_len
```