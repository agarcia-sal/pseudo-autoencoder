```
function numSubmatrixSumTarget(matrix, target):
    define subarraySum(nums, target):
        count ← 0
        seen_sums ← map with default 0
        cum_sum ← 0
        for num in nums:
            cum_sum += num
            if cum_sum = target: count += 1
            if cum_sum - target in seen_sums: count += seen_sums[cum_sum - target]
            seen_sums[cum_sum] += 1
        return count

    rows, cols ← size(matrix), size(matrix[0])
    total_count ← 0

    for top in 0..rows-1:
        curr_cols ← array of zeros length cols
        for bottom in top..rows-1:
            for col in 0..cols-1:
                curr_cols[col] += matrix[bottom][col]
            total_count += subarraySum(curr_cols, target)

    return total_count
```