```
def countOfAtoms(formula):
    parse = segment -> map of atom:count from regex ([A-Z][a-z]*)(\d*)
    mult = (counts, m) -> multiply all counts by m

    stack = [empty map]
    i = 0
    while i < len(formula):
        if formula[i] == '(':
            push empty map on stack; i++
        else if formula[i] == ')':
            j = i+1
            while j<len(formula) and digit(formula[j]): j++
            m = int(formula[i+1:j]) if j>i+1 else 1
            top = mult(pop stack, m)
            merge top into stack[-1]
            i = j
        else:
            j = i+1
            while j<len(formula) and (islower(formula[j]) or digit(formula[j])): j++
            partial = parse(formula[i:j])
            merge partial into stack[-1]
            i = j

    res = pop stack
    return concat sorted keys with counts >1 in form: atom + count
```