```
max_beauty(flowers):
  idxs = dict of lists for flower → positions
  prefix = [0] * (len(flowers)+1)
  for i in 0 to len(flowers)-1:
    prefix[i+1] = prefix[i] + max(flowers[i],0)
    append i to idxs[flowers[i]]

  max_b = -∞
  for b in keys(idxs):
    if len(idxs[b]) ≥ 2:
      f, l = idxs[b][0], idxs[b][-1]
      val = 2*b + prefix[l] - prefix[f+1]
      max_b = max(max_b, val)

  return max_b
```