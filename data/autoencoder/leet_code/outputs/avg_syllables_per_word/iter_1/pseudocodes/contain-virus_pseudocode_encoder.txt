```
define neighbors(r, c): return [(r+1,c), (r-1,c), (r,c+1), (r,c-1)]

define bfs(r, c):
  infected, threatened = {}, {}
  queue, visited = deque([(r, c)]), {(r, c)}
  while queue:
    x,y = queue.popleft()
    infected.add((x,y))
    for nx, ny in neighbors(x,y):
      if 0<=nx<m and 0<=ny<n and (nx, ny) not in visited:
        visited.add((nx, ny))
        if isInfected[nx][ny] == 1: queue.append((nx, ny))
        else if isInfected[nx][ny] == 0: threatened.add((nx, ny))
  return infected, threatened

define build_walls(infected):
  walls = 0
  for x,y in infected:
    for nx,ny in neighbors(x,y):
      if 0<=nx<m and 0<=ny<n and isInfected[nx][ny] == 0: walls += 1
  return walls

define spread_virus(threatened):
  for x,y in threatened: isInfected[x][y] = 1

m,n = len(isInfected), len(isInfected[0])
total_walls = 0

while True:
  regions, visited = [], set()
  for r in range(m):
    for c in range(n):
      if isInfected[r][c] == 1 and (r,c) not in visited:
        infected, threatened = bfs(r,c)
        regions.append((infected, threatened))
        visited |= infected
  if not regions: break
  regions.sort by descending size of threatened
  total_walls += build_walls(regions[0][0])
  for x,y in regions[0][0]: isInfected[x][y] = -1
  for region in regions[1:]: spread_virus(region[1])

return total_walls
```