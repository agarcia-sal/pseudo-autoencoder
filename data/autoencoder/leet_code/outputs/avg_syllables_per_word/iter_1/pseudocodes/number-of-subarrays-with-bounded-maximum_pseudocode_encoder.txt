```
def numSubarrayBoundedMax(nums, left, right):
    def count(max_val):
        c = 0; length = 0
        for n in nums:
            if n <= max_val: length += 1; c += length
            else: length = 0
        return c
    return count(right) - count(left - 1)
```