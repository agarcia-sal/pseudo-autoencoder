CLASS Solution
    FUNCTION countCombinations(pieces, positions)
        SET directions TO
            "rook" MAPPED TO list of (1, 0), (-1, 0), (0, 1), (0, -1)
            "queen" MAPPED TO list of (1, 0), (-1, 0), (0, 1), (0, -1), (1, 1), (-1, 1), (1, -1), (-1, -1)
            "bishop" MAPPED TO list of (1, 1), (-1, 1), (1, -1), (-1, -1)

        SET positions TO list of (r MINUS 1, c MINUS 1) FOR each (r, c) IN positions

        FUNCTION get_destinations(start, piece_type)
            SET r, c TO start
            SET dests TO list containing start
            FOR each (dr, dc) IN directions MAPPED FROM piece_type
                SET nr TO r PLUS dr
                SET nc TO c PLUS dc
                WHILE nr GREATER THAN OR EQUAL TO 0 AND nr LESS THAN 8 AND nc GREATER THAN OR EQUAL TO 0 AND nc LESS THAN 8
                    APPEND (nr, nc) TO dests
                    SET nr TO nr PLUS dr
                    SET nc TO nc PLUS dc
            RETURN dests
        END FUNCTION

        SET all_destinations TO list of get_destinations(pos, piece) FOR each pos, piece IN zip of positions and pieces

        FUNCTION is_valid_combination(combination)
            SET pos TO a copy of positions
            SET n TO LENGTH OF pos
            WHILE True
                IF LENGTH OF set from pos LESS THAN n
                    RETURN False
                SET all_reached TO True
                FOR i FROM 0 TO n MINUS 1
                    IF pos AT i EQUALS combination AT i
                        CONTINUE to next iteration
                    SET all_reached TO False
                    SET r, c TO pos AT i
                    IF combination AT i FIRST element GREATER THAN r
                        SET dr TO 1
                    ELSE IF combination AT i FIRST element LESS THAN r
                        SET dr TO -1
                    ELSE
                        SET dr TO 0
                    IF combination AT i SECOND element GREATER THAN c
                        SET dc TO 1
                    ELSE IF combination AT i SECOND element LESS THAN c
                        SET dc TO -1
                    ELSE
                        SET dc TO 0
                    SET pos AT i TO (r PLUS dr, c PLUS dc)
                IF all_reached
                    RETURN True
        END FUNCTION

        SET valid_count TO 0
        FOR each combination IN Cartesian product of all_destinations
            IF is_valid_combination(combination)
                INCREMENT valid_count BY 1

        RETURN valid_count
    END FUNCTION
END CLASS