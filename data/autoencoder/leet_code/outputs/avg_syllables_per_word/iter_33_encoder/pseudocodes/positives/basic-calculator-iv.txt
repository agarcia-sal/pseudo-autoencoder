CLASS Term  
    FUNCTION __init__(self, coefficient, variables)  
        SET self.coefficient TO coefficient  
        SET self.variables TO variables  
    END FUNCTION  
  
    FUNCTION __lt__(self, other)  
        IF the LENGTH OF self.variables NOT EQUALS the LENGTH OF other.variables THEN  
            RETURN the LENGTH OF self.variables GREATER THAN the LENGTH OF other.variables  
        END IF  
        SET self_joined TO the CONCATENATION OF the ELEMENTS OF self.variables WITH each ELEMENT JOINED BY the WORD STAR  
        SET other_joined TO the CONCATENATION OF the ELEMENTS OF other.variables WITH each ELEMENT JOINED BY the WORD STAR  
        RETURN self_joined LESS THAN other_joined  
    END FUNCTION  
  
    FUNCTION __repr__(self)  
        IF the LENGTH OF self.variables EQUALS zero THEN  
            RETURN the STRING REPRESENTATION OF self.coefficient  
        END IF  
        SET joined_vars TO the CONCATENATION OF the ELEMENTS OF self.variables WITH each ELEMENT JOINED BY the WORD STAR  
        RETURN the STRING REPRESENTATION OF self.coefficient FOLLOWED BY the WORD STAR FOLLOWED BY joined_vars  
    END FUNCTION  
END CLASS  
  
CLASS Expression  
    FUNCTION __init__(self)  
        SET self.terms TO a mapping FROM default integer value  
    END FUNCTION  
  
    FUNCTION add_term(self, term)  
        SET key TO the TUPLE OF the SORTED ELEMENTS OF term.variables  
        INCREMENT the VALUE at key IN self.terms BY term.coefficient  
    END FUNCTION  
  
    FUNCTION multiply(self, other)  
        CREATE result AS a NEW Expression  
        FOR each vars1 AND coeff1 IN the ITEMS OF self.terms  
            FOR each vars2 AND coeff2 IN the ITEMS OF other.terms  
                SET combined_vars_list TO the SORTED LIST OF the ELEMENTS OF vars1 PLUS the ELEMENTS OF vars2  
                CREATE new_term AS a NEW Term WITH coefficient coeff1 MULTIPLIED BY coeff2 AND variables combined_vars_list  
                CALL add_term ON result WITH new_term  
            END FOR  
        END FOR  
        RETURN result  
    END FUNCTION  
  
    FUNCTION add(self, other)  
        FOR each vars AND coeff IN the ITEMS OF other.terms  
            CREATE new_term AS a NEW Term WITH coefficient coeff AND variables AS the LIST OF vars  
            CALL add_term ON self WITH new_term  
        END FOR  
        RETURN self  
    END FUNCTION  
  
    FUNCTION subtract(self, other)  
        FOR each vars AND coeff IN the ITEMS OF other.terms  
            CREATE new_term AS a NEW Term WITH coefficient MINUS coeff AND variables AS the LIST OF vars  
            CALL add_term ON self WITH new_term  
        END FOR  
        RETURN self  
    END FUNCTION  
  
    FUNCTION evaluate(self, var_map)  
        CREATE result AS a NEW Expression  
        FOR each vars AND coeff IN the ITEMS OF self.terms  
            CREATE new_vars AS an EMPTY LIST  
            FOR each var IN vars  
                IF var IS A KEY IN var_map THEN  
                    APPEND the STRING REPRESENTATION OF the VALUE at var IN var_map TO new_vars  
                ELSE  
                    APPEND var TO new_vars  
                END IF  
            END FOR  
            IF the LENGTH OF new_vars EQUALS zero THEN  
                SET new_coeff TO one  
            ELSE  
                SET new_coeff TO the EVALUATION OF the CONCATENATION OF the ELEMENTS OF new_vars WITH no SEPARATORS  
            END IF  
            CREATE new_term AS a NEW Term WITH coefficient coeff MULTIPLIED BY new_coeff AND variables AS an EMPTY LIST  
            CALL add_term ON result WITH new_term  
        END FOR  
        RETURN result  
    END FUNCTION  
  
    FUNCTION simplify(self)  
        CREATE simplified_terms AS an EMPTY LIST  
        FOR each vars AND coeff IN the ITEMS OF self.terms  
            IF coeff NOT EQUALS zero THEN  
                CREATE new_term AS a NEW Term WITH coefficient coeff AND variables AS the LIST OF vars  
                APPEND new_term TO simplified_terms  
            END IF  
        END FOR  
        SORT simplified_terms USING THE __lt__ METHOD OF Term  
        RETURN simplified_terms  
    END FUNCTION  
  
    FUNCTION __repr__(self)  
        SET simplified_list TO the CALL TO simplify METHOD OF self  
        SET string_list TO an EMPTY LIST  
        FOR each term IN simplified_list  
            APPEND the RESULT OF the CALL TO __repr__ METHOD OF term TO string_list  
        END FOR  
        RETURN the CONCATENATION OF the ELEMENTS OF string_list WITH the STRING literal space PLUS space AS SEPARATOR  
    END FUNCTION  
END CLASS  
  
CLASS Solution  
    FUNCTION basicCalculatorIV(self, expression, evalvars, evalints)  
        SET var_map TO a MAPPING FROM evalvars TO evalints BY PAIRING CORRESPONDING ELEMENTS  
        SET tokens TO the LIST OF substrings IN expression MATCHING the PATTERN of LEFT PARENTHESIS OR RIGHT PARENTHESIS OR PLUS OR MINUS OR STAR OR one OR MORE DIGITS OR one OR MORE LETTERS  
        SET output TO an EMPTY LIST  
        SET operators TO an EMPTY LIST  
  
        FUNCTION apply_operator()  
            SET right TO the LAST ELEMENT REMOVED FROM output  
            SET left TO the LAST ELEMENT REMOVED FROM output  
            SET op TO the LAST ELEMENT REMOVED FROM operators  
            IF op EQUALS the STRING plus THEN  
                APPEND the RESULT OF CALLING add METHOD ON left WITH right TO output  
            ELSE IF op EQUALS the STRING minus THEN  
                APPEND the RESULT OF CALLING subtract METHOD ON left WITH right TO output  
            ELSE IF op EQUALS the STRING star THEN  
                APPEND the RESULT OF CALLING multiply METHOD ON left WITH right TO output  
            END IF  
        END FUNCTION  
  
        SET i TO zero  
        WHILE i LESS THAN the LENGTH OF tokens DO  
            SET token TO the ELEMENT AT POSITION i OF tokens  
            IF token CONTAINS only DIGITS THEN  
                CREATE new_expression AS a NEW Expression  
                CREATE new_term AS a NEW Term WITH coefficient THE INTEGER VALUE OF token AND variables AS an EMPTY LIST  
                CALL add_term ON new_expression WITH new_term  
                APPEND new_expression TO output  
            ELSE IF token CONTAINS only LETTERS THEN  
                CREATE new_expression AS a NEW Expression  
                SET coef TO the VALUE at token IN var_map IF token IS A KEY IN var_map OTHERWISE one  
                IF coef EQUALS one THEN  
                    IF token IS NOT A KEY IN var_map THEN  
                        CREATE new_term AS a NEW Term WITH coefficient one AND variables AS a LIST CONTAINING token  
                    ELSE  
                        CREATE new_term AS a NEW Term WITH coefficient one AND variables AS an EMPTY LIST  
                    END IF  
                ELSE  
                    CREATE new_term AS a NEW Term WITH coefficient coef AND variables AS an EMPTY LIST  
                END IF  
                CALL add_term ON new_expression WITH new_term  
                APPEND new_expression TO output  
            ELSE IF token EQUALS the LEFT PARENTHESIS THEN  
                APPEND token TO operators  
            ELSE IF token EQUALS the RIGHT PARENTHESIS THEN  
                WHILE operators IS NOT EMPTY AND the LAST ELEMENT OF operators NOT EQUALS the LEFT PARENTHESIS DO  
                    CALL apply_operator()  
                END WHILE  
                REMOVE the LAST ELEMENT FROM operators  
            ELSE IF token EQUALS the STRING plus OR token EQUALS the STRING minus OR token EQUALS the STRING star THEN  
                WHILE operators IS NOT EMPTY AND the LAST ELEMENT OF operators NOT EQUALS the LEFT PARENTHESIS AND  
                      (token EQUALS the STRING plus OR token EQUALS the STRING minus OR the LAST ELEMENT OF operators EQUALS the STRING star) DO  
                    CALL apply_operator()  
                END WHILE  
                APPEND token TO operators  
            END IF  
            INCREMENT i BY one  
        END WHILE  
  
        WHILE operators IS NOT EMPTY DO  
            CALL apply_operator()  
        END WHILE  
  
        SET simplified_terms TO the RESULT OF CALLING simplify METHOD ON the FIRST ELEMENT OF output  
        CREATE result_strings AS an EMPTY LIST  
        FOR each term IN simplified_terms  
            IF the LENGTH OF term.variables EQUALS zero THEN  
                APPEND the STRING REPRESENTATION OF term.coefficient TO result_strings  
            ELSE  
                SET joined_vars TO the CONCATENATION OF the ELEMENTS OF term.variables WITH each ELEMENT JOINED BY the WORD STAR  
                APPEND the STRING REPRESENTATION OF term.coefficient FOLLOWED BY the WORD STAR FOLLOWED BY joined_vars TO result_strings  
            END IF  
        END FOR  
        RETURN result_strings  
    END FUNCTION  
END CLASS