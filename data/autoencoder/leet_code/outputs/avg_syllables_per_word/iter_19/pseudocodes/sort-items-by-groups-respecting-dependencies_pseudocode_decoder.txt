CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR each index i FROM zero TO n MINUS one  
            IF element at position i of group EQUALS minus one  
                SET element at position i of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  

        INITIALIZE group_items AS a mapping from group identifier TO list of item indices  
        INITIALIZE group_graph AS a mapping from group identifier TO list of dependent group identifiers  
        INITIALIZE item_graph AS a mapping from item index TO list of dependent item indices  
        INITIALIZE item_in_degree AS list of zeros of length n  
        INITIALIZE group_in_degree AS list of zeros of length m  

        FOR each index i FROM zero TO n MINUS one  
            APPEND i TO the list assigned to element at position i of group in group_items  
        END FOR  

        FOR each index i FROM zero TO n MINUS one  
            FOR each element before IN element at position i of beforeItems  
                IF element at position before of group EQUALS element at position i of group  
                    APPEND i TO the list assigned to before in item_graph  
                    INCREMENT element at position i of item_in_degree BY one  
                ELSE  
                    APPEND element at position i of group TO the list assigned to element at position before of group in group_graph  
                    INCREMENT element at position i of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  

        FUNCTION topological_sort(graph, in_degree, items)  
            INITIALIZE q AS deque containing each item IN items WHERE the element at position item of in_degree EQUALS zero  
            INITIALIZE result AS empty list  
            WHILE q is not empty  
                SET u TO the element popped from the left of q  
                APPEND u TO result  
                FOR each element v IN the list assigned to u in graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO q  
                    END IF  
                END FOR  
            END WHILE  
            IF the LENGTH OF result EQUALS the LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN empty list  
            END IF  
        END FUNCTION  

        INITIALIZE sorted_within_groups AS empty list  
        FOR each list items IN the values of group_items  
            SET sorted_items TO the result of topological_sort called with item_graph, item_in_degree, and items  
            IF sorted_items IS empty  
                RETURN empty list  
            END IF  
            EXTEND sorted_within_groups BY each element IN sorted_items  
        END FOR  

        SET sorted_groups TO the result of topological_sort called with group_graph, group_in_degree, and a list of integers FROM zero TO m MINUS one  
        IF sorted_groups IS empty  
            RETURN empty list  
        END IF  

        INITIALIZE group_to_items_map AS a mapping from group identifier TO empty list  
        FOR each element item IN sorted_within_groups  
            APPEND item TO the list assigned to element at position item of group in group_to_items_map  
        END FOR  

        INITIALIZE result AS empty list  
        FOR each element group_id IN sorted_groups  
            EXTEND result BY each element IN the list assigned to group_id in group_to_items_map  
        END FOR  

        RETURN result  
    END FUNCTION  
END CLASS