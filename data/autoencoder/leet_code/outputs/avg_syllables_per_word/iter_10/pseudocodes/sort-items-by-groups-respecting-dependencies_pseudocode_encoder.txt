CLASS Solution
    FUNCTION sortItems(n, m, group, beforeItems)
        FOR index FROM zero TO n MINUS one
            IF element at position index of group EQUALS minus one
                SET element at position index of group TO m
                INCREMENT m BY one
            END IF
        END FOR

        SET group_items TO a new default dictionary of list
        SET group_graph TO a new default dictionary of list
        SET item_graph TO a new default dictionary of list
        SET item_in_degree TO a list with n elements each set to zero
        SET group_in_degree TO a list with m elements each set to zero

        FOR index FROM zero TO n MINUS one
            APPEND index TO list at key element at position index of group in group_items
        END FOR

        FOR index FROM zero TO n MINUS one
            FOR each before_element IN element at position index of beforeItems
                IF element at position before_element of group EQUALS element at position index of group
                    APPEND index TO list at key before_element in item_graph
                    INCREMENT element at position index of item_in_degree BY one
                ELSE
                    APPEND element at position index of group TO list at key element at position before_element of group in group_graph
                    INCREMENT element at position element at position index of group of group_in_degree BY one
                END IF
            END FOR
        END FOR

        FUNCTION topological_sort(graph, in_degree, items)
            SET q TO a new deque containing each item IN items WHERE element at position item of in_degree EQUALS zero
            SET result TO an empty list
            WHILE q is not empty
                SET u TO the first element REMOVED FROM q
                APPEND u TO result
                FOR each v IN list at key u in graph
                    DECREMENT element at position v of in_degree BY one
                    IF element at position v of in_degree EQUALS zero
                        APPEND v TO q
                    END IF
                END FOR
            END WHILE
            IF LENGTH OF result EQUALS LENGTH OF items
                RETURN result
            ELSE
                RETURN an empty list
            END IF
        END FUNCTION

        SET sorted_within_groups TO an empty list
        FOR each items IN values of group_items
            SET sorted_items TO CALL topological_sort with item_graph, item_in_degree, and items
            IF sorted_items IS an empty list
                RETURN an empty list
            END IF
            EXTEND sorted_within_groups BY sorted_items
        END FOR

        SET sorted_groups TO CALL topological_sort with group_graph, group_in_degree, and list from zero TO m MINUS one
        IF sorted_groups IS an empty list
            RETURN an empty list
        END IF

        SET group_to_items_map TO a new default dictionary of list
        FOR each item IN sorted_within_groups
            APPEND item TO list at key element at position item of group in group_to_items_map
        END FOR

        SET result TO an empty list
        FOR each group_id IN sorted_groups
            EXTEND result BY list at key group_id in group_to_items_map
        END FOR

        RETURN result
    END FUNCTION
END CLASS