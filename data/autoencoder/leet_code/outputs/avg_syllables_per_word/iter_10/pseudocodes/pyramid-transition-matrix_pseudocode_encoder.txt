CLASS Solution  
    FUNCTION pyramidTransition(bottom, allowed)  
        SET allowed_map TO result of calling map_with_default_lists FUNCTION  
        FOR each rule IN allowed  
            SET left TO first element of rule  
            SET right TO second element of rule  
            SET top TO third element of rule  
            APPEND top TO list at allowed_map at key left then key right  
        END FOR  

        FUNCTION can_build_pyramid(current_bottom, current_top)  
            IF the LENGTH OF current_bottom EQUALS one  
                RETURN True  
            END IF  
            IF the LENGTH OF current_top EQUALS the LENGTH OF current_bottom MINUS one  
                RETURN the result of calling can_build_pyramid with current_top and empty list  
            END IF  

            SET left TO element at position the LENGTH OF current_top of current_bottom  
            SET right TO element at position the LENGTH OF current_top PLUS one of current_bottom  
            IF left IS a key IN allowed_map AND right IS a key IN allowed_map at left  
                FOR each top IN list at allowed_map at key left then key right  
                    IF calling can_build_pyramid with current_bottom and current_top appended by top RETURNS True  
                        RETURN True  
                    END IF  
                END FOR  
            END IF  
            RETURN False  
        END FUNCTION  

        RETURN the result of calling can_build_pyramid with bottom and empty list  
    END FUNCTION  
END CLASS  

FUNCTION map_with_default_lists  
    DESCRIBE creation of a mapping from keys to mappings from keys to lists that automatically create new empty lists on missing keys  
END FUNCTION