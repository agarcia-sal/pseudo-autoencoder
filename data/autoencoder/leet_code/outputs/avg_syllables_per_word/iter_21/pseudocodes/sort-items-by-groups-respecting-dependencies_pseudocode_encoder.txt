CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR index FROM zero TO n MINUS one  
            IF element at position index OF group EQUALS minus one  
                SET element at position index OF group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        CALL initialize_default_dictionary_of_list WITH PARAMETER group_items  
        CALL initialize_default_dictionary_of_list WITH PARAMETER group_graph  
        CALL initialize_default_dictionary_of_list WITH PARAMETER item_graph  
        SET item_in_degree TO list OF zero REPEATED n TIMES  
        SET group_in_degree TO list OF zero REPEATED m TIMES  
        
        FOR index FROM zero TO n MINUS one  
            APPEND index TO element at position element at position index OF group OF group_items  
        END FOR  
        
        FOR index FROM zero TO n MINUS one  
            FOR each before_element IN element at position index OF beforeItems  
                IF element at position before_element OF group EQUALS element at position index OF group  
                    APPEND index TO element at position before_element OF item_graph  
                    INCREMENT element at position index OF item_in_degree BY one  
                ELSE  
                    APPEND element at position index OF group TO element at position element at position before_element OF group OF group_graph  
                    INCREMENT element at position element at position index OF group OF group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET queue TO double ended queue CONTAINING elements FROM items WHERE element AT POSITION element OF in_degree EQUALS zero  
            SET result TO empty list  
            WHILE queue IS NOT empty  
                REMOVE element FROM front OF queue AND ASSIGN TO variable u  
                APPEND u TO result  
                FOR each element v IN element at position u OF graph  
                    DECREMENT element at position v OF in_degree BY one  
                    IF element at position v OF in_degree EQUALS zero  
                        APPEND v TO queue  
                    END IF  
                END FOR  
            END WHILE  
            IF LENGTH OF result EQUALS LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN empty list  
            END IF  
        END FUNCTION  
        
        SET sorted_within_groups TO empty list  
        FOR each items IN all values OF group_items  
            SET sorted_items TO CALL topological_sort WITH PARAMETERS item_graph, item_in_degree, items  
            IF sorted_items IS empty list  
                RETURN empty list  
            END IF  
            EXTEND sorted_within_groups BY sorted_items  
        END FOR  
        
        SET sorted_groups TO CALL topological_sort WITH PARAMETERS group_graph, group_in_degree, list OF integers FROM zero TO m MINUS one  
        IF sorted_groups IS empty list  
            RETURN empty list  
        END IF  
        
        CALL initialize_default_dictionary_of_list WITH PARAMETER group_to_items_map  
        FOR each item IN sorted_within_groups  
            APPEND item TO element at position element at position item OF group OF group_to_items_map  
        END FOR  
        
        SET result TO empty list  
        FOR each group_element IN sorted_groups  
            EXTEND result BY element at position group_element OF group_to_items_map  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS