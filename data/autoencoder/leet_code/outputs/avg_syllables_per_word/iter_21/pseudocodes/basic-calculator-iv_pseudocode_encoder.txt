CLASS Term  
    FUNCTION __init__(coefficient, variables)  
        SET self.coefficient TO coefficient  
        SET self.variables TO variables  
    END FUNCTION  

    FUNCTION __lt__(other)  
        IF the LENGTH OF self.variables NOT EQUALS the LENGTH OF other.variables THEN  
            RETURN the LENGTH OF self.variables GREATER THAN the LENGTH OF other.variables  
        END IF  
        RETURN the STRING OBTAINED BY JOINING self.variables WITH ASTERISK LESS THAN the STRING OBTAINED BY JOINING other.variables WITH ASTERISK  
    END FUNCTION  

    FUNCTION __repr__()  
        IF self.variables IS EMPTY THEN  
            RETURN a STRING REPRESENTATION OF self.coefficient  
        END IF  
        RETURN a STRING CONSISTING OF self.coefficient FOLLOWED BY ASTERISK FOLLOWED BY the STRING OBTAINED BY JOINING self.variables WITH ASTERISK  
    END FUNCTION  
END CLASS  

CLASS Expression  
    FUNCTION __init__()  
        SET self.terms TO a NEW DEFAULTDICTIONARY WITH DEFAULT VALUE ZERO FOR INTEGERS  
    END FUNCTION  

    FUNCTION add_term(term)  
        SET key TO a TUPLE OF THE SORTED term.variables  
        INCREMENT self.terms AT key BY term.coefficient  
    END FUNCTION  

    FUNCTION multiply(other)  
        SET result TO a NEW Expression  
        FOR each vars1 AND coeff1 IN self.terms ITEMS  
            FOR each vars2 AND coeff2 IN other.terms ITEMS  
                SET combined_vars TO the SORTED LIST OF vars1 CONCATENATED WITH vars2  
                CALL result.add_term WITH PARAMETERS Term WITH PARAMETERS coeff1 MULTIPLIED BY coeff2 AND combined_vars  
            END FOR  
        END FOR  
        RETURN result  
    END FUNCTION  

    FUNCTION add(other)  
        FOR each vars AND coeff IN other.terms ITEMS  
            CALL self.add_term WITH PARAMETERS Term WITH PARAMETERS coeff AND the LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  

    FUNCTION subtract(other)  
        FOR each vars AND coeff IN other.terms ITEMS  
            CALL self.add_term WITH PARAMETERS Term WITH PARAMETERS NEGATION OF coeff AND the LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  

    FUNCTION evaluate(var_map)  
        SET result TO a NEW Expression  
        FOR each vars AND coeff IN self.terms ITEMS  
            SET new_vars TO an EMPTY LIST  
            FOR each var IN vars  
                IF var EXISTS IN var_map THEN  
                    APPEND the STRING REPRESENTATION OF var_map AT var TO new_vars  
                ELSE  
                    APPEND var TO new_vars  
                END IF  
            END FOR  
            IF new_vars IS NOT EMPTY THEN  
                SET new_coeff TO the EVALUATION OF the CONCATENATION OF ELEMENTS OF new_vars  
            ELSE  
                SET new_coeff TO ONE  
            END IF  
            CALL result.add_term WITH PARAMETERS Term WITH PARAMETERS coeff MULTIPLIED BY new_coeff AND an EMPTY LIST  
        END FOR  
        RETURN result  
    END FUNCTION  

    FUNCTION simplify()  
        SET simplified_terms TO a LIST OF Term OBJECTS CONSTRUCTED WITH PARAMETERS coeff AND the LIST OF vars FOR EACH vars AND coeff IN self.terms ITEMS WHERE coeff NOT EQUALS ZERO  
        SORT simplified_terms USING THE __lt__ FUNCTION OF Term  
        RETURN simplified_terms  
    END FUNCTION  

    FUNCTION __repr__()  
        RETURN the STRING OBTAINED BY JOINING WITH PLUS THE REPRESENTATIONS OF EACH TERM IN self.simplify()  
    END FUNCTION  
END CLASS  

CLASS Solution  
    FUNCTION basicCalculatorIV(expression, evalvars, evalints)  
        SET var_map TO a DICTIONARY MAPPING EACH ELEMENT OF evalvars TO THE CORRESPONDING ELEMENT OF evalints BY POSITION  
        SET tokens TO the RESULT OF FINDING ALL SUBSTRINGS IN expression MATCHING PARENTHESES ADDITION MINUS MULTIPLICATION DIGITS OR WORD CHARACTERS USING REGULAR EXPRESSION  
        SET output TO an EMPTY LIST  
        SET operators TO an EMPTY LIST  
        
        FUNCTION apply_operator()  
            SET right TO REMOVE THE LAST ELEMENT FROM output  
            SET left TO REMOVE THE LAST ELEMENT FROM output  
            SET op TO REMOVE THE LAST ELEMENT FROM operators  
            IF op EQUALS PLUS SIGN THEN  
                APPEND left.add(right) TO output  
            ELSE IF op EQUALS MINUS SIGN THEN  
                APPEND left.subtract(right) TO output  
            ELSE IF op EQUALS ASTERISK THEN  
                APPEND left.multiply(right) TO output  
            END IF  
        END FUNCTION  
        
        SET i TO ZERO  
        WHILE i LESS THAN the LENGTH OF tokens HOLDS  
            SET token TO the ELEMENT AT POSITION i OF tokens  
            IF token CONTAINS ONLY DIGITS THEN  
                APPEND a NEW Expression TO output  
                CALL the LAST ELEMENT OF output.add_term WITH PARAMETERS Term WITH PARAMETERS THE INTEGER VALUE OF token AND AN EMPTY LIST  
            ELSE IF token CONTAINS ONLY ALPHABETS THEN  
                APPEND a NEW Expression TO output  
                SET coef TO var_map GET token WITH DEFAULT ONE  
                IF coef EQUALS ONE THEN  
                    IF token EXISTS IN var_map THEN  
                        CALL the LAST ELEMENT OF output.add_term WITH PARAMETERS Term WITH PARAMETERS ONE AND AN EMPTY LIST  
                    ELSE  
                        CALL the LAST ELEMENT OF output.add_term WITH PARAMETERS Term WITH PARAMETERS ONE AND A LIST CONTAINING token  
                    END IF  
                ELSE  
                    CALL the LAST ELEMENT OF output.add_term WITH PARAMETERS Term WITH PARAMETERS coef AND AN EMPTY LIST  
                END IF  
            ELSE IF token EQUALS LEFT PARENTHESIS THEN  
                APPEND token TO operators  
            ELSE IF token EQUALS RIGHT PARENTHESIS THEN  
                WHILE operators IS NOT EMPTY AND THE LAST ELEMENT OF operators NOT EQUALS LEFT PARENTHESIS HOLDS  
                    CALL apply_operator()  
                END WHILE  
                REMOVE THE LAST ELEMENT FROM operators TO DISCARD LEFT PARENTHESIS  
            ELSE IF token IS ONE OF PLUS SIGN MINUS SIGN ASTERISK THEN  
                WHILE operators IS NOT EMPTY AND THE LAST ELEMENT OF operators NOT EQUALS LEFT PARENTHESIS AND (token IS PLUS SIGN OR MINUS SIGN OR THE LAST ELEMENT OF operators EQUALS ASTERISK) HOLDS  
                    CALL apply_operator()  
                END WHILE  
                APPEND token TO operators  
            END IF  
            INCREMENT i BY ONE  
        END WHILE  
        
        WHILE operators IS NOT EMPTY  
            CALL apply_operator()  
        END WHILE  
        
        SET simplified_terms TO CALL THE simplify() FUNCTION OF THE FIRST ELEMENT OF output  
        
        SET result_strings TO an EMPTY LIST  
        FOR each term IN simplified_terms  
            IF term.variables IS NOT EMPTY THEN  
                APPEND a STRING CONSISTING OF term.coefficient FOLLOWED BY ASTERISK FOLLOWED BY the STRING OBTAINED BY JOINING term.variables WITH ASTERISK TO result_strings  
            ELSE  
                APPEND a STRING REPRESENTATION OF term.coefficient TO result_strings  
            END IF  
        END FOR  
        
        RETURN result_strings  
    END FUNCTION  
END CLASS