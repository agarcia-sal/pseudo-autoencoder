CLASS Solution  
    FUNCTION countCombinations(pieces AS List of string, positions AS List of List of integer) RETURNS integer  
        SET directions TO a mapping from string TO list of pairs of integer  
        SET directions AT key rook TO list containing pair of integer one zero, pair of integer negative one zero, pair of integer zero one, pair of integer zero negative one  
        SET directions AT key queen TO list containing pair of integer one zero, pair of integer negative one zero, pair of integer zero one, pair of integer zero negative one, pair of integer one one, pair of integer negative one one, pair of integer one negative one, pair of integer negative one negative one  
        SET directions AT key bishop TO list containing pair of integer one one, pair of integer negative one one, pair of integer one negative one, pair of integer negative one negative one  
  
        SET positions TO a new list formed by  
            FOR each pair r c IN positions  
                RETURN pair of integer r MINUS one, c MINUS one  
            END FOR  
  
        FUNCTION get_destinations(start AS pair of integer, piece_type AS string) RETURNS list of pair of integer  
            SET r TO the first element of start  
            SET c TO the second element of start  
            SET dests TO a new list containing start  
            FOR each pair dr dc IN directions AT key piece_type  
                SET nr TO r PLUS dr  
                SET nc TO c PLUS dc  
                WHILE nr IS GREATER THAN OR EQUAL TO zero AND nr IS LESS THAN eight AND nc IS GREATER THAN OR EQUAL TO zero AND nc IS LESS THAN eight  
                    APPEND pair of integer nr nc TO dests  
                    INCREMENT nr BY dr  
                    INCREMENT nc BY dc  
                END WHILE  
            END FOR  
            RETURN dests  
        END FUNCTION  
  
        SET all_destinations TO a new list formed by  
            FOR each pair pos piece IN zipped positions AND pieces  
                RETURN the result of get_destinations with arguments pos AND piece  
            END FOR  
  
        FUNCTION is_valid_combination(combination AS tuple of pair of integer) RETURNS boolean  
            SET pos TO a new list copied from positions  
            SET n TO the LENGTH OF pos  
            WHILE true  
                IF the LENGTH OF the set formed from pos IS LESS THAN n  
                    RETURN false  
                END IF  
                SET all_reached TO true  
                FOR index i FROM zero TO n MINUS one  
                    IF element at position i of pos EQUALS element at position i of combination  
                        CONTINUE to next iteration  
                    END IF  
                    SET all_reached TO false  
                    SET r TO the first element of element at position i of pos  
                    SET c TO the second element of element at position i of pos  
                    IF the first element of element at position i of combination IS GREATER THAN r  
                        SET dr TO one  
                    ELSE IF the first element of element at position i of combination IS LESS THAN r  
                        SET dr TO negative one  
                    ELSE  
                        SET dr TO zero  
                    END IF  
                    IF the second element of element at position i of combination IS GREATER THAN c  
                        SET dc TO one  
                    ELSE IF the second element of element at position i of combination IS LESS THAN c  
                        SET dc TO negative one  
                    ELSE  
                        SET dc TO zero  
                    END IF  
                    SET element at position i of pos TO pair of integer r PLUS dr, c PLUS dc  
                END FOR  
                IF all_reached  
                    RETURN true  
                END IF  
            END WHILE  
        END FUNCTION  
  
        SET valid_count TO zero  
        FOR each combination IN the Cartesian product of all_destinations  
            IF is_valid_combination with argument combination  
                INCREMENT valid_count BY one  
            END IF  
        END FOR  
  
        RETURN valid_count  
    END FUNCTION  
END CLASS