CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR each index i FROM zero TO n MINUS one  
            IF element at position i of group EQUALS negative one  
                SET element at position i of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        CREATE a mapping group_items FROM each group TO list of items in that group INITIALIZED as empty lists  
        CREATE a mapping group_graph FROM each group TO list of dependent groups INITIALIZED as empty lists  
        CREATE a mapping item_graph FROM each item TO list of dependent items INITIALIZED as empty lists  
        CREATE a list item_in_degree OF length n FILLED WITH zero  
        CREATE a list group_in_degree OF length m FILLED WITH zero  
        
        FOR each index i FROM zero TO n MINUS one  
            APPEND i TO the list corresponding to element at position i of group IN group_items  
        END FOR  
        
        FOR each index i FROM zero TO n MINUS one  
            FOR each element before IN element at position i of beforeItems  
                IF element at position before of group EQUALS element at position i of group  
                    APPEND i TO the list corresponding to before IN item_graph  
                    INCREMENT element at position i of item_in_degree BY one  
                ELSE  
                    APPEND element at position i of group TO the list corresponding to element at position before of group IN group_graph  
                    INCREMENT element at position i of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            CREATE a queue q INITIALIZED WITH all elements item IN items WHERE element at position item of in_degree EQUALS zero  
            CREATE an empty list result  
            WHILE q IS NOT empty  
                REMOVE the first element u FROM q  
                APPEND u TO result  
                FOR each element v IN the list corresponding to u IN graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO q  
                    END IF  
                END FOR  
            END WHILE  
            IF the LENGTH OF result EQUALS the LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN an empty list  
            END IF  
        END FUNCTION  
        
        CREATE an empty list sorted_within_groups  
        FOR each items IN the values of group_items  
            SET sorted_items TO the result of calling topological_sort WITH item_graph, item_in_degree, and items  
            IF sorted_items IS empty  
                RETURN an empty list  
            END IF  
            APPEND all elements of sorted_items TO sorted_within_groups  
        END FOR  
        
        SET sorted_groups TO the result of calling topological_sort WITH group_graph, group_in_degree, and the list of integers from zero TO m MINUS one  
        IF sorted_groups IS empty  
            RETURN an empty list  
        END IF  
        
        CREATE a mapping group_to_items_map FROM each group TO empty list  
        FOR each item IN sorted_within_groups  
            APPEND item TO the list corresponding to element at position item of group IN group_to_items_map  
        END FOR  
        
        CREATE an empty list result  
        FOR each group_element IN sorted_groups  
            APPEND all elements of the list corresponding to group_element IN group_to_items_map TO result  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS