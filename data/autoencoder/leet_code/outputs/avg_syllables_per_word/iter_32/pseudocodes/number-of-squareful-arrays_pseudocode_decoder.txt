CLASS Solution  
    FUNCTION numSquarefulPerms(nums)  
        FUNCTION is_square(n)  
            SET root TO the square root of n converted to an integer  
            IF root MULTIPLIED BY root EQUALS n THEN  
                RETURN true  
            ELSE  
                RETURN false  
            END IF  
        END FUNCTION  

        FUNCTION backtrack(path, count)  
            IF the LENGTH OF path EQUALS the LENGTH OF nums THEN  
                RETURN one  
            END IF  

            SET ans TO zero  
            FOR each element x IN count  
                IF the element at key x in count IS GREATER THAN zero AND (the LENGTH OF path EQUALS zero OR is_square(the element at the last position of path PLUS x)) THEN  
                    DECREMENT the element at key x in count BY one  
                    INCREMENT ans BY backtrack(the path APPENDED WITH x, count)  
                    INCREMENT the element at key x in count BY one  
                END IF  
            END FOR  
            RETURN ans  
        END FUNCTION  

        SET count TO a mapping of the number of occurrences of each element in nums  
        RETURN backtrack(an empty list, count)  
    END FUNCTION  
END CLASS