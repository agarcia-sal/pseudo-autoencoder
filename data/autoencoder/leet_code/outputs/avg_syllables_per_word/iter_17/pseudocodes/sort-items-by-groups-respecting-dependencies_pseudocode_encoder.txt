CLASS Solution
    FUNCTION sortItems(n, m, group, beforeItems)
        FOR index FROM zero TO n MINUS one
            IF element at position index of group EQUALS negative one
                SET element at position index of group TO m
                INCREMENT m BY one
            END IF
        END FOR

        SET group_items TO CALL defaultdict WITH parameter list
        SET group_graph TO CALL defaultdict WITH parameter list
        SET item_graph TO CALL defaultdict WITH parameter list
        SET item_in_degree TO a LIST of length n FILLED WITH zero
        SET group_in_degree TO a LIST of length m FILLED WITH zero

        FOR index FROM zero TO n MINUS one
            CALL APPEND index TO the element at position element at position index of group OF group_items
        END FOR

        FOR index FROM zero TO n MINUS one
            FOR each before IN element at position index of beforeItems
                IF element at position before of group EQUALS element at position index of group
                    CALL APPEND index TO the element at position before OF item_graph
                    INCREMENT element at position index of item_in_degree BY one
                ELSE
                    CALL APPEND element at position index of group TO the element at position element at position before of group_graph
                    INCREMENT element at position element at position index of group of group_in_degree BY one
                END IF
            END FOR
        END FOR

        FUNCTION topological_sort(graph, in_degree, items)
            SET q TO a deque OF all elements item IN items WHERE element at position item of in_degree EQUALS zero
            SET result TO empty list
            WHILE q is not empty
                SET u TO the element REMOVED FROM FRONT OF q
                CALL APPEND u TO result
                FOR each v IN element at position u OF graph
                    DECREMENT element at position v of in_degree BY one
                    IF element at position v of in_degree EQUALS zero
                        CALL APPEND v TO q
                    END IF
                END FOR
            END WHILE
            IF the LENGTH OF result EQUALS the LENGTH OF items
                RETURN result
            ELSE
                RETURN empty list
            END IF
        END FUNCTION

        SET sorted_within_groups TO empty list
        FOR each items IN the VALUES OF group_items
            SET sorted_items TO CALL topological_sort WITH parameters item_graph, item_in_degree, items
            IF sorted_items is empty
                RETURN empty list
            END IF
            CALL EXTEND sorted_within_groups WITH sorted_items
        END FOR

        SET sorted_groups TO CALL topological_sort WITH parameters group_graph, group_in_degree, LIST FROM zero TO m MINUS one
        IF sorted_groups is empty
            RETURN empty list
        END IF

        SET group_to_items_map TO CALL defaultdict WITH parameter list
        FOR each item IN sorted_within_groups
            CALL APPEND item TO the element at position element at position item of group OF group_to_items_map
        END FOR

        SET result TO empty list
        FOR each group_element IN sorted_groups
            CALL EXTEND result WITH element at position group_element OF group_to_items_map
        END FOR

        RETURN result
    END FUNCTION
END CLASS