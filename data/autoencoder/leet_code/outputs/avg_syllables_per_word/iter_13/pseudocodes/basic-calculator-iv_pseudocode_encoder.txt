CLASS Term  
    FUNCTION __init__(self, coefficient, variables)  
        SET self.coefficient TO coefficient  
        SET self.variables TO variables  
    END FUNCTION  
    
    FUNCTION __lt__(self, other)  
        IF THE LENGTH OF self.variables IS NOT EQUAL TO THE LENGTH OF other.variables THEN  
            RETURN THE LENGTH OF self.variables IS GREATER THAN THE LENGTH OF other.variables  
        END IF  
        RETURN THE STRING JOINED BY ASTERISK OF self.variables IS LESS THAN THE STRING JOINED BY ASTERISK OF other.variables  
    END FUNCTION  
    
    FUNCTION __repr__(self)  
        IF self.variables IS EMPTY THEN  
            RETURN THE STRING REPRESENTATION OF self.coefficient  
        END IF  
        RETURN THE STRING FORM OF self.coefficient CONCATENATED WITH ASTERISK CONCATENATED WITH THE STRING JOINED BY ASTERISK OF self.variables  
    END FUNCTION  
END CLASS  

CLASS Expression  
    FUNCTION __init__(self)  
        SET self.terms TO A DEFAULT DICTIONARY OF INTEGER DEFAULT  
    END FUNCTION  
    
    FUNCTION add_term(self, term)  
        SET key TO A TUPLE OF THE SORTED LIST OF term.variables  
        INCREMENT self.terms AT key BY term.coefficient  
    END FUNCTION  
    
    FUNCTION multiply(self, other)  
        CREATE result AS A NEW INSTANCE OF Expression  
        FOR EACH vars1 AND coeff1 IN self.terms ITEMS  
            FOR EACH vars2 AND coeff2 IN other.terms ITEMS  
                SET combined_vars TO THE SORTED LIST OF vars1 CONCATENATED WITH vars2  
                CALL result.add_term WITH A NEW Term OF coefficient AS coeff1 MULTIPLIED BY coeff2 AND variables AS combined_vars  
            END FOR  
        END FOR  
        RETURN result  
    END FUNCTION  
    
    FUNCTION add(self, other)  
        FOR EACH vars AND coeff IN other.terms ITEMS  
            CALL self.add_term WITH A NEW Term OF coefficient coeff AND variables AS THE LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  
    
    FUNCTION subtract(self, other)  
        FOR EACH vars AND coeff IN other.terms ITEMS  
            CALL self.add_term WITH A NEW Term OF coefficient NEGATIVE coeff AND variables AS THE LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  
    
    FUNCTION evaluate(self, var_map)  
        CREATE result AS A NEW INSTANCE OF Expression  
        FOR EACH vars AND coeff IN self.terms ITEMS  
            CREATE new_vars AS AN EMPTY LIST  
            FOR EACH var IN vars  
                IF var IS IN var_map KEYS THEN  
                    APPEND THE STRING FORM OF var_map AT var TO new_vars  
                ELSE  
                    APPEND var TO new_vars  
                END IF  
            END FOR  
            IF new_vars IS NOT EMPTY THEN  
                SET new_coeff TO THE EVALUATION OF THE CONCATENATION OF ELEMENTS OF new_vars AS A MATHEMATICAL EXPRESSION  
            ELSE  
                SET new_coeff TO ONE  
            END IF  
            CALL result.add_term WITH A NEW Term OF coefficient coeff MULTIPLIED BY new_coeff AND variables AS AN EMPTY LIST  
        END FOR  
        RETURN result  
    END FUNCTION  
    
    FUNCTION simplify(self)  
        SET simplified_terms TO A LIST OF Term INSTANCES CREATED FROM coeff AND LIST OF vars FOR EACH vars AND coeff IN self.terms ITEMS WHERE coeff IS NOT ZERO  
        SORT simplified_terms USING THE Term CLASS COMPARISON  
        RETURN simplified_terms  
    END FUNCTION  
    
    FUNCTION __repr__(self)  
        RETURN THE STRING JOINED BY SPACE PLUS SPACE OF THE STRING REPRESENTATION OF EACH term FROM self.simplify()  
    END FUNCTION  
END CLASS  

CLASS Solution  
    FUNCTION basicCalculatorIV(self, expression, evalvars, evalints)  
        SET var_map TO A DICTIONARY CREATED FROM ZIPPING evalvars AND evalints  
        SET tokens TO THE LIST OF MATCHES OF PATTERN MATCHING OPEN PARENTHESES OR CLOSE PARENTHESES OR PLUS OR MINUS OR MULTIPLY OR ONE OR MORE DIGITS OR ONE OR MORE WORD CHARACTERS IN expression  
        CREATE output AS AN EMPTY LIST  
        CREATE operators AS AN EMPTY LIST  
        
        FUNCTION apply_operator()  
            SET right TO THE LAST ELEMENT REMOVED FROM output  
            SET left TO THE LAST ELEMENT REMOVED FROM output  
            SET op TO THE LAST ELEMENT REMOVED FROM operators  
            IF op IS EQUAL TO PLUS SIGN THEN  
                APPEND TO output THE RESULT OF CALLING add METHOD ON left WITH right  
            ELSE IF op IS EQUAL TO MINUS SIGN THEN  
                APPEND TO output THE RESULT OF CALLING subtract METHOD ON left WITH right  
            ELSE IF op IS EQUAL TO ASTERISK THEN  
                APPEND TO output THE RESULT OF CALLING multiply METHOD ON left WITH right  
            END IF  
        END FUNCTION  
        
        SET i TO ZERO  
        WHILE i IS LESS THAN THE LENGTH OF tokens DO  
            SET token TO THE ELEMENT AT POSITION i OF tokens  
            IF token CONSISTS OF ONLY DIGITS THEN  
                APPEND A NEW INSTANCE OF Expression TO output  
                CALL add_term ON THE LAST ELEMENT OF output WITH A NEW Term OF coefficient AS THE INTEGER FORM OF token AND EMPTY variables LIST  
            ELSE IF token CONSISTS OF ONLY ALPHABETICAL CHARACTERS THEN  
                APPEND A NEW INSTANCE OF Expression TO output  
                SET coef TO THE VALUE IN var_map AT token IF token IS IN var_map KEYS OTHERWISE ONE  
                IF coef IS EQUAL TO ONE THEN  
                    IF token IS NOT IN var_map KEYS THEN  
                        CALL add_term ON THE LAST ELEMENT OF output WITH A NEW Term OF coefficient ONE AND variables AS A LIST OF token  
                    ELSE  
                        CALL add_term ON THE LAST ELEMENT OF output WITH A NEW Term OF coefficient ONE AND EMPTY variables LIST  
                    END IF  
                ELSE  
                    CALL add_term ON THE LAST ELEMENT OF output WITH A NEW Term OF coefficient coef AND EMPTY variables LIST  
                END IF  
            ELSE IF token IS AN OPEN PARENTHESES THEN  
                APPEND token TO operators  
            ELSE IF token IS A CLOSE PARENTHESES THEN  
                WHILE operators IS NOT EMPTY AND THE LAST ELEMENT OF operators IS NOT AN OPEN PARENTHESES DO  
                    CALL apply_operator()  
                END WHILE  
                REMOVE THE LAST ELEMENT FROM operators  
            ELSE IF token IS PLUS SIGN OR MINUS SIGN OR ASTERISK THEN  
                WHILE operators IS NOT EMPTY AND THE LAST ELEMENT OF operators IS NOT AN OPEN PARENTHESES AND  
                      (token IS PLUS SIGN OR MINUS SIGN OR THE LAST ELEMENT OF operators IS ASTERISK) DO  
                    CALL apply_operator()  
                END WHILE  
                APPEND token TO operators  
            END IF  
            INCREMENT i BY ONE  
        END WHILE  
        
        WHILE operators IS NOT EMPTY DO  
            CALL apply_operator()  
        END WHILE  
        
        SET simplified_terms TO THE RESULT OF calling simplify METHOD ON THE FIRST ELEMENT OF output  
        
        RETURN A LIST WHERE FOR EACH term IN simplified_terms THERE IS  
            IF term.variables IS NOT EMPTY THEN  
                THE STRING OF term.coefficient CONCATENATED WITH ASTERISK CONCATENATED WITH THE STRING JOINED BY ASTERISK OF term.variables  
            ELSE  
                THE STRING REPRESENTATION OF term.coefficient  
            END IF  
    END FUNCTION  
END CLASS