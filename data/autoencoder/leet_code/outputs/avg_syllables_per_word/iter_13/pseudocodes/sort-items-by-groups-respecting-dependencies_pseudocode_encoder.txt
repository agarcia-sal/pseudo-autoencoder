CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR index FROM zero TO n MINUS one  
            IF element at position index of group EQUALS negative one  
                SET element at position index of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  

        ASSIGN pointer TO new default list structure for group_items  
        ASSIGN pointer TO new default list structure for group_graph  
        ASSIGN pointer TO new default list structure for item_graph  
        SET item_in_degree TO list of zeros with length n  
        SET group_in_degree TO list of zeros with length m  

        FOR index FROM zero TO n MINUS one  
            APPEND index TO list at key which is element at position index of group in group_items  
        END FOR  

        FOR index FROM zero TO n MINUS one  
            FOR each element before IN list at position index of beforeItems  
                IF element at position before of group EQUALS element at position index of group  
                    APPEND index TO list at key before in item_graph  
                    INCREMENT element at position index of item_in_degree BY one  
                ELSE  
                    APPEND element at position index of group TO list at key element at position before of group in group_graph  
                    INCREMENT element at position element at position index of group of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  

        FUNCTION topological_sort(graph, in_degree, items)  
            ASSIGN pointer TO new deque initialized with elements of items where element at position of in_degree EQUALS zero  
            SET result TO empty list  
            WHILE deque is not empty  
                REMOVE and ASSIGN front element of deque TO u  
                APPEND u TO result  
                FOR each element v IN list at key u in graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO deque  
                    END IF  
                END FOR  
            END WHILE  
            IF SIZE OF result EQUALS SIZE OF items  
                RETURN result  
            ELSE  
                RETURN empty list  
            END IF  
        END FUNCTION  

        SET sorted_within_groups TO empty list  
        FOR each items_list IN values of group_items  
            SET sorted_items TO topological_sort(item_graph, item_in_degree, items_list)  
            IF sorted_items IS empty  
                RETURN empty list  
            END IF  
            EXTEND sorted_within_groups BY elements of sorted_items  
        END FOR  

        SET sorted_groups TO topological_sort(group_graph, group_in_degree, list of elements FROM zero TO m MINUS one)  
        IF sorted_groups IS empty  
            RETURN empty list  
        END IF  

        ASSIGN pointer TO new default list structure for group_to_items_map  
        FOR each item IN sorted_within_groups  
            APPEND item TO list at key element at position item of group in group_to_items_map  
        END FOR  

        SET result TO empty list  
        FOR each group_element IN sorted_groups  
            EXTEND result BY elements of list at key group_element in group_to_items_map  
        END FOR  

        RETURN result  
    END FUNCTION  
END CLASS