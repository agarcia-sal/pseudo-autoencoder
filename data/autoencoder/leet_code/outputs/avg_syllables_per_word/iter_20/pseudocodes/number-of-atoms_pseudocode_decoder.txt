CLASS Solution  
    FUNCTION countOfAtoms(formula)  
        FUNCTION parse(segment)  
            SET atom_count TO a new map with default integer zero  
            SET elements TO all pairs of an uppercase letter followed by zero or more lowercase letters AND zero or more digits found in segment  
            FOR each element_name AND count_string IN elements  
                IF count_string IS NOT empty  
                    SET count_value TO the integer value of count_string  
                ELSE  
                    SET count_value TO one  
                END IF  
                INCREMENT the value at element_name in atom_count BY count_value  
            END FOR  
            RETURN atom_count  
        END FUNCTION  
      
        FUNCTION multiply_counts(counts, multiplier)  
            FOR each element_name IN counts  
                SET the value at element_name in counts TO the value at element_name in counts MULTIPLIED BY multiplier  
            END FOR  
            RETURN counts  
        END FUNCTION  
      
        SET stack TO a list containing a new map with default integer zero  
        SET i TO zero  
        WHILE i IS LESS THAN the length of formula  
            IF the element at position i of formula EQUALS an opening parenthesis  
                APPEND a new map with default integer zero TO stack  
                INCREMENT i BY one  
            ELSE IF the element at position i of formula EQUALS a closing parenthesis  
                SET segment_count TO a new map with default integer zero  
                SET j TO i PLUS one  
                WHILE j IS LESS THAN the length of formula AND the element at position j of formula IS a digit  
                    INCREMENT j BY one  
                END WHILE  
                IF j IS GREATER THAN i PLUS one  
                    SET multiplier TO the integer value formed by the substring from position i PLUS one TO j MINUS one of formula  
                ELSE  
                    SET multiplier TO one  
                END IF  
                SET segment_count TO multiply_counts(the last element removed from stack, multiplier)  
                FOR each element_name IN segment_count  
                    INCREMENT the value at element_name in the last element of stack BY the value at element_name in segment_count  
                END FOR  
                SET i TO j  
            ELSE  
                SET j TO i PLUS one  
                WHILE j IS LESS THAN the length of formula AND (the element at position j of formula IS a lowercase letter OR the element at position j of formula IS a digit)  
                    INCREMENT j BY one  
                END WHILE  
                SET segment_count TO parse(the substring from position i TO j MINUS one of formula)  
                FOR each element_name IN segment_count  
                    INCREMENT the value at element_name in the last element of stack BY the value at element_name in segment_count  
                END FOR  
                SET i TO j  
            END IF  
        END WHILE  
      
        SET final_count TO the last element removed from stack  
        RETURN the concatenation of each element_name followed by the string of its count if the count IS GREATER THAN one OTHERWISE empty string FOR each element_name in the sorted list of keys of final_count  
    END FUNCTION  
END CLASS