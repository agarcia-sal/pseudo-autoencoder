from collections import defaultdict
from typing import List

class Solution:
    def minMalwareSpread(self, graph: List[List[int]], initial: List[int]) -> int:
        number_of_nodes = len(graph)
        adjacency_list = defaultdict(list)

        for index in range(number_of_nodes):
            for inner_index in range(index + 1, number_of_nodes):
                if graph[index][inner_index] == 1:
                    adjacency_list[index].append(inner_index)
                    adjacency_list[inner_index].append(index)

        def dfs(node: int, visited: set[int]) -> int:
            if node in visited:
                return 0
            visited.add(node)
            size = 1
            for neighbor in adjacency_list[node]:
                size += dfs(neighbor, visited)
            return size

        infected_nodes = set(initial)
        component_sizes: List[int] = []
        visited_nodes: set[int] = set()
        component_index_mapping = dict()  # node -> component index

        # Explore all safe components (nodes not infected)
        for node in range(number_of_nodes):
            if node not in visited_nodes and node not in infected_nodes:
                component_size = dfs(node, visited_nodes)
                component_sizes.append(component_size)
                index_reverse = len(component_sizes) - 1
                # Assign this component index to all neighbors of this node
                for neighbor in adjacency_list[node]:
                    component_index_mapping[neighbor] = index_reverse

        infected_component_count = defaultdict(int)
        for infected_node in infected_nodes:
            if infected_node in component_index_mapping:
                cidx = component_index_mapping[infected_node]
                infected_component_count[cidx] += 1

        maximum_size = 0
        node_to_remove = min(initial)

        for infected_node in infected_nodes:
            if infected_node in component_index_mapping:
                component_idx = component_index_mapping[infected_node]
                if infected_component_count[component_idx] == 1:
                    csize = component_sizes[component_idx]
                    if csize > maximum_size:
                        maximum_size = csize
                        node_to_remove = infected_node
                    elif csize == maximum_size and infected_node < node_to_remove:
                        node_to_remove = infected_node

        return node_to_remove