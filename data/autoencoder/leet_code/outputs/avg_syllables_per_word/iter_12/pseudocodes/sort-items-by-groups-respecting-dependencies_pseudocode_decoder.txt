CLASS Solution
    FUNCTION sortItems(n, m, group, beforeItems)
        FOR index FROM zero TO n MINUS one
            IF element at position index of group EQUALS negative one
                SET element at position index of group TO m
                INCREMENT m BY one
            END IF
        END FOR

        CALL initialize_defaultdict_list AS group_items
        CALL initialize_defaultdict_list AS group_graph
        CALL initialize_defaultdict_list AS item_graph
        SET item_in_degree TO list of zero repeated n times
        SET group_in_degree TO list of zero repeated m times

        FOR index FROM zero TO n MINUS one
            APPEND index TO element at position element at position index of group of group_items
        END FOR

        FOR index FROM zero TO n MINUS one
            FOR each before_element IN element at position index of beforeItems
                IF element at position before_element of group EQUALS element at position index of group
                    APPEND index TO element at position before_element of item_graph
                    INCREMENT element at position index of item_in_degree BY one
                ELSE
                    APPEND element at position index of group TO element at position element at position before_element of group_graph
                    INCREMENT element at position element at position index of group of group_in_degree BY one
                END IF
            END FOR
        END FOR

        FUNCTION topological_sort(graph, in_degree, items)
            INITIALIZE q AS a deque containing each item IN items WHERE element at position item of in_degree EQUALS zero
            SET result TO empty list
            WHILE q IS NOT empty
                REMOVE first element FROM q AND SET TO u
                APPEND u TO result
                FOR each v IN element at position u of graph
                    DECREMENT element at position v of in_degree BY one
                    IF element at position v of in_degree EQUALS zero
                        APPEND v TO q
                    END IF
                END FOR
            END WHILE
            IF LENGTH OF result EQUALS LENGTH OF items
                RETURN result
            ELSE
                RETURN empty list
            END IF
        END FUNCTION

        SET sorted_within_groups TO empty list
        FOR each items IN values of group_items
            SET sorted_items TO CALL topological_sort WITH item_graph, item_in_degree, items
            IF sorted_items IS empty
                RETURN empty list
            END IF
            APPEND all elements of sorted_items TO sorted_within_groups
        END FOR

        SET sorted_groups TO CALL topological_sort WITH group_graph, group_in_degree, list of integers from zero TO m MINUS one
        IF sorted_groups IS empty
            RETURN empty list
        END IF

        CALL initialize_defaultdict_list AS group_to_items_map
        FOR each item IN sorted_within_groups
            APPEND item TO element at position element at position item of group of group_to_items_map
        END FOR

        SET result TO empty list
        FOR each group_element IN sorted_groups
            APPEND all elements of element at position group_element of group_to_items_map TO result
        END FOR

        RETURN result
    END FUNCTION

    FUNCTION initialize_defaultdict_list()
        RETURN a new empty mapping that returns empty list for missing keys
    END FUNCTION
END CLASS