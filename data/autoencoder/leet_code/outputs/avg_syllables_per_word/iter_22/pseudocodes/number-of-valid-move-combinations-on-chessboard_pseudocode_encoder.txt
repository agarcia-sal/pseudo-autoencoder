CLASS Solution  
    FUNCTION countCombinations(pieces positions)  
        SET directions TO a mapping where  
            the key rook maps TO a list of pairs representing one step vertically and horizontally in all four directions  
            the key queen maps TO a list of pairs representing one step vertically horizontally and diagonally in all eight directions  
            the key bishop maps TO a list of pairs representing one step diagonally in all four directions  
        SET positions TO a list constructed by for each pair of row and column in positions setting row MINUS one and column MINUS one  
        
        FUNCTION get_destinations(start piece_type)  
            DESTRUCTURE start INTO r and c  
            SET dests TO a list containing start to represent a piece staying in its original position  
            FOR each pair dr and dc IN the list mapped by piece_type in directions  
                SET nr TO r PLUS dr  
                SET nc TO c PLUS dc  
                WHILE nr is greater than or equal to zero AND nr is less than eight AND nc is greater than or equal to zero AND nc is less than eight  
                    APPEND the pair consisting of nr and nc TO dests  
                    INCREMENT nr BY dr  
                    INCREMENT nc BY dc  
                END WHILE  
            END FOR  
            RETURN dests  
        END FUNCTION  
        
        SET all_destinations TO a list constructed by pairing each pos and piece from positions and pieces applying get_destinations on pos and piece  
        
        FUNCTION is_valid_combination(combination)  
            SET pos TO a copy of positions  
            SET n TO the length of pos  
            WHILE true  
                IF the length of the set created from pos is less than n  
                    RETURN false  
                END IF  
                SET all_reached TO true  
                FOR i FROM zero TO n MINUS one  
                    IF the element at position i of pos EQUALS the element at position i of combination  
                        CONTINUE to the next iteration of the loop  
                    END IF  
                    SET all_reached TO false  
                    DESTRUCTURE the element at position i of pos INTO r and c  
                    SET dr TO one IF the element at position i of combination at first position is GREATER THAN r ELSE negative one IF the element at position i of combination at first position is LESS THAN r ELSE zero  
                    SET dc TO one IF the element at position i of combination at second position is GREATER THAN c ELSE negative one IF the element at position i of combination at second position is LESS THAN c ELSE zero  
                    SET the element at position i of pos TO the pair consisting of r PLUS dr and c PLUS dc  
                END FOR  
                IF all_reached  
                    RETURN true  
                END IF  
            END WHILE  
        END FUNCTION  
        
        SET valid_count TO zero  
        FOR each combination IN the Cartesian product of all_destinations unpacked  
            IF is_valid_combination(combination)  
                INCREMENT valid_count BY one  
            END IF  
        END FOR  
        
        RETURN valid_count  
    END FUNCTION  
END CLASS