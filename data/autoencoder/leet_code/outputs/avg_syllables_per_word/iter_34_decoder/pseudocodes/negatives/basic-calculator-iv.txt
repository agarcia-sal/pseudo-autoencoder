CLASS Term  
    FUNCTION __init__ with parameters coefficient variables  
        SET self coefficient TO coefficient  
        SET self variables TO variables  
    END FUNCTION  
  
    FUNCTION __lt__ with parameters other  
        IF the LENGTH OF self variables NOT EQUALS the LENGTH OF other variables  
            RETURN whether the LENGTH OF self variables IS GREATER THAN the LENGTH OF other variables  
        END IF  
        RETURN whether the STRING formed by JOINING self variables WITH the word MULTIPLIED BY IS LESS THAN the STRING formed by JOINING other variables WITH the word MULTIPLIED BY  
    END FUNCTION  
  
    FUNCTION __repr__  
        IF the LENGTH OF self variables EQUALS zero  
            RETURN the STRING form of self coefficient  
        END IF  
        RETURN the STRING concatenation of the STRING form of self coefficient FOLLOWED BY the word MULTIPLIED BY FOLLOWED BY the STRING formed by JOINING self variables WITH the word MULTIPLIED BY  
    END FUNCTION  
END CLASS  
  
CLASS Expression  
    FUNCTION __init__  
        SET self terms TO a new default dictionary mapping to zero  
    END FUNCTION  
  
    FUNCTION add_term with parameter term  
        SET key TO the tuple of the SORTED list of term variables  
        INCREMENT the value at key in self terms BY term coefficient  
    END FUNCTION  
  
    FUNCTION multiply with parameter other  
        SET result TO a new Expression  
        FOR each vars1 coeff1 PAIR IN the items of self terms  
            FOR each vars2 coeff2 PAIR IN the items of other terms  
                SET combined_vars TO the SORTED list formed by CONCATENATING vars1 AND vars2  
                CALL result add_term WITH a new Term initialized with coefficient equal to coeff1 MULTIPLIED BY coeff2 and variables equal to combined_vars  
            END FOR  
        END FOR  
        RETURN result  
    END FUNCTION  
  
    FUNCTION add with parameter other  
        FOR each vars coeff PAIR IN the items of other terms  
            CALL self add_term WITH a new Term initialized with coefficient coeff and variables equal to the list of vars  
        END FOR  
        RETURN self  
    END FUNCTION  
  
    FUNCTION subtract with parameter other  
        FOR each vars coeff PAIR IN the items of other terms  
            CALL self add_term WITH a new Term initialized with coefficient MINUS coeff and variables equal to the list of vars  
        END FOR  
        RETURN self  
    END FUNCTION  
  
    FUNCTION evaluate with parameter var_map  
        SET result TO a new Expression  
        FOR each vars coeff PAIR IN the items of self terms  
            SET new_vars TO an empty list  
            FOR each var IN vars  
                IF var IS IN var_map  
                    APPEND the STRING form of the value at var in var_map TO new_vars  
                ELSE  
                    APPEND var TO new_vars  
                END IF  
            END FOR  
            IF the LENGTH OF new_vars IS GREATER THAN zero  
                SET new_coeff TO the evaluation of the STRING formed by JOINING all elements in new_vars with empty separation  
            ELSE  
                SET new_coeff TO one  
            END IF  
            CALL result add_term WITH a new Term initialized with coefficient equal to coeff MULTIPLIED BY new_coeff and variables equal to an empty list  
        END FOR  
        RETURN result  
    END FUNCTION  
  
    FUNCTION simplify  
        SET simplified_terms TO a list  
        FOR each vars coeff PAIR IN the items of self terms  
            IF coeff NOT EQUALS zero  
                APPEND a new Term initialized with coefficient coeff and variables equal to the list of vars TO simplified_terms  
            END IF  
        END FOR  
        SORT simplified_terms  
        RETURN simplified_terms  
    END FUNCTION  
  
    FUNCTION __repr__  
        RETURN the STRING formed by JOINING with the string plus the list obtained by MAPPING the __repr__ function OVER the result of calling self simplify  
    END FUNCTION  
END CLASS  
  
CLASS Solution  
    FUNCTION basicCalculatorIV with parameters expression evalvars evalints  
        SET var_map TO a dictionary formed by pairing elements of evalvars WITH elements of evalints  
        SET tokens TO the list of substrings found in expression matching the pattern consisting of any one of the following single characters parenthesis left parenthesis right plus minus asterisk or a sequence of digits or a sequence of word characters  
        SET output TO an empty list  
        SET operators TO an empty list  
  
        FUNCTION apply_operator  
            SET right TO the last element REMOVED FROM output  
            SET left TO the last element REMOVED FROM output  
            SET op TO the last element REMOVED FROM operators  
            IF op EQUALS the string plus  
                APPEND to output the result of calling left add WITH right  
            ELSE IF op EQUALS the string minus  
                APPEND to output the result of calling left subtract WITH right  
            ELSE IF op EQUALS the string asterisk  
                APPEND to output the result of calling left multiply WITH right  
            END IF  
        END FUNCTION  
  
        SET i TO zero  
        WHILE i IS LESS THAN the LENGTH OF tokens  
            SET token TO the element at position i of tokens  
            IF token is a sequence consisting only of digits  
                APPEND a new Expression TO output  
                CALL the last element of output add_term WITH a new Term initialized with coefficient equal to the integer value of token and variables equal to an empty list  
            ELSE IF token is a sequence consisting only of alphabetic characters  
                APPEND a new Expression TO output  
                SET coef TO the value at token in var_map IF it EXISTS otherwise one  
                IF coef EQUALS one  
                    CALL the last element of output add_term WITH a new Term initialized with coefficient one and variables equal to a list containing token IF token NOT IN var_map otherwise an empty list  
                ELSE  
                    CALL the last element of output add_term WITH a new Term initialized with coefficient coef and variables equal to an empty list  
                END IF  
            ELSE IF token EQUALS the string left parenthesis  
                APPEND token TO operators  
            ELSE IF token EQUALS the string right parenthesis  
                WHILE operators is not empty AND the last element of operators NOT EQUALS the string left parenthesis  
                    CALL apply_operator  
                END WHILE  
                REMOVE the last element from operators  
            ELSE IF token is one of the strings plus minus asterisk  
                WHILE operators is not empty AND the last element of operators NOT EQUALS the string left parenthesis AND (token EQUALS plus OR token EQUALS minus OR the last element of operators EQUALS the string asterisk)  
                    CALL apply_operator  
                END WHILE  
                APPEND token TO operators  
            END IF  
            INCREMENT i BY one  
        END WHILE  
  
        WHILE operators is not empty  
            CALL apply_operator  
        END WHILE  
  
        SET simplified_terms TO the result of calling simplify ON the first element of output  
        SET result TO an empty list  
        FOR each term IN simplified_terms  
            IF the LENGTH OF term variables IS GREATER THAN zero  
                APPEND the STRING concatenation of the STRING form of term coefficient FOLLOWED BY the word MULTIPLIED BY FOLLOWED BY the STRING formed by JOINING term variables WITH the word MULTIPLIED BY TO result  
            ELSE  
                APPEND the STRING form of term coefficient TO result  
            END IF  
        END FOR  
        RETURN result  
    END FUNCTION  
END CLASS