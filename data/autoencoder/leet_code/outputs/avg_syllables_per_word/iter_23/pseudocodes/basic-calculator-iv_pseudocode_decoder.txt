CLASS Term  
    FUNCTION __init__(self coefficient variables)  
        SET self.coefficient TO coefficient  
        SET self.variables TO variables  
    END FUNCTION  
  
    FUNCTION __lt__(self other)  
        IF the LENGTH OF self.variables NOT EQUALS the LENGTH OF other.variables THEN  
            RETURN the LENGTH OF self.variables GREATER THAN the LENGTH OF other.variables  
        END IF  
        RETURN the STRING FORMED BY JOINING the ELEMENTS OF self.variables WITH the WORD 'ASTERISK' LESS THAN the STRING FORMED BY JOINING the ELEMENTS OF other.variables WITH the WORD 'ASTERISK'  
    END FUNCTION  
  
    FUNCTION __repr__(self)  
        IF the LENGTH OF self.variables EQUALS zero THEN  
            RETURN the STRING REPRESENTATION OF self.coefficient  
        END IF  
        RETURN the STRING FORMED BY CONCATENATING the STRING REPRESENTATION OF self.coefficient WITH the WORD 'ASTERISK' AND THE STRING FORMED BY JOINING the ELEMENTS OF self.variables WITH the WORD 'ASTERISK'  
    END FUNCTION  
END CLASS  
  
CLASS Expression  
    FUNCTION __init__(self)  
        SET self.terms TO a DEFAULT DICTIONARY WITH DEFAULT VALUE zero  
    END FUNCTION  
  
    FUNCTION add_term(self term)  
        SET key TO the TUPLE OF the SORTED ELEMENTS OF term.variables  
        INCREMENT the VALUE at key IN self.terms BY term.coefficient  
    END FUNCTION  
  
    FUNCTION multiply(self other)  
        SET result TO a NEW Expression  
        FOR each vars1 AND coeff1 IN the ITEMS OF self.terms  
            FOR each vars2 AND coeff2 IN the ITEMS OF other.terms  
                SET combined_vars TO the SORTED LIST OF the CONCATENATION OF vars1 AND vars2  
                CALL result.add_term WITH A NEW Term WITH coefficient coeff1 MULTIPLIED BY coeff2 AND variables combined_vars  
            END FOR  
        END FOR  
        RETURN result  
    END FUNCTION  
  
    FUNCTION add(self other)  
        FOR each vars AND coeff IN the ITEMS OF other.terms  
            CALL self.add_term WITH A NEW Term WITH coefficient coeff AND variables AS the LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  
  
    FUNCTION subtract(self other)  
        FOR each vars AND coeff IN the ITEMS OF other.terms  
            CALL self.add_term WITH A NEW Term WITH coefficient negation OF coeff AND variables AS the LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  
  
    FUNCTION evaluate(self var_map)  
        SET result TO a NEW Expression  
        FOR each vars AND coeff IN the ITEMS OF self.terms  
            SET new_vars TO an EMPTY LIST  
            FOR each var IN vars  
                IF var IS PRESENT IN var_map THEN  
                    APPEND the STRING REPRESENTATION OF the VALUE MAPPED TO var IN var_map TO new_vars  
                ELSE  
                    APPEND var TO new_vars  
                END IF  
            END FOR  
            IF the LENGTH OF new_vars EQUALS zero THEN  
                SET new_coeff TO one  
            ELSE  
                SET new_coeff TO the EVALUATION OF the STRING FORMED BY CONCATENATING THE ELEMENTS OF new_vars  
            END IF  
            CALL result.add_term WITH A NEW Term WITH coefficient coeff MULTIPLIED BY new_coeff AND variables AS an EMPTY LIST  
        END FOR  
        RETURN result  
    END FUNCTION  
  
    FUNCTION simplify(self)  
        SET simplified_terms TO an EMPTY LIST  
        FOR each vars AND coeff IN the ITEMS OF self.terms  
            IF coeff NOT EQUALS zero THEN  
                APPEND A NEW Term WITH coefficient coeff AND variables AS the LIST OF vars TO simplified_terms  
            END IF  
        END FOR  
        SORT simplified_terms USING THE __lt__ METHOD OF Term  
        RETURN simplified_terms  
    END FUNCTION  
  
    FUNCTION __repr__(self)  
        RETURN the STRING FORMED BY JOINING THE REPRESENTATIONS OF THE TERMS IN self.simplify() WITH the WORD 'PLUS'  
    END FUNCTION  
END CLASS  
  
CLASS Solution  
    FUNCTION basicCalculatorIV(self expression evalvars evalints)  
        SET var_map TO a DICTIONARY MAP CREATED FROM ZIPPING evalvars WITH evalints  
        SET tokens TO the LIST OF SUBSTRINGS FOUND BY MATCHING THE PATTERN OF LEFT PARENTHESIS OR RIGHT PARENTHESIS OR PLUS OR MINUS OR ASTERISK OR DIGITS OR WORD CHARACTERS IN expression  
        SET output TO an EMPTY LIST  
        SET operators TO an EMPTY LIST  
  
        FUNCTION apply_operator()  
            SET right TO the LAST ELEMENT REMOVED FROM output  
            SET left TO the LAST ELEMENT REMOVED FROM output  
            SET op TO the LAST ELEMENT REMOVED FROM operators  
            IF op EQUALS the STRING PLUS THEN  
                APPEND left.add(right) TO output  
            ELSE IF op EQUALS the STRING MINUS THEN  
                APPEND left.subtract(right) TO output  
            ELSE IF op EQUALS the STRING ASTERISK THEN  
                APPEND left.multiply(right) TO output  
            END IF  
        END FUNCTION  
  
        SET i TO zero  
        WHILE i LESS THAN the LENGTH OF tokens  
            SET token TO the ELEMENT AT POSITION i IN tokens  
            IF token CONSISTS OF ONLY DIGITS THEN  
                APPEND A NEW Expression TO output  
                CALL THE add_term METHOD OF THE LAST ELEMENT IN output WITH A NEW Term WITH coefficient AS THE INTEGER VALUE OF token AND AN EMPTY LIST FOR variables  
            ELSE IF token CONSISTS OF ONLY ALPHABETIC CHARACTERS THEN  
                APPEND A NEW Expression TO output  
                SET coef TO the VALUE MAPPED TO token IN var_map OR one IF NOT PRESENT  
                IF coef EQUALS one THEN  
                    IF token IS NOT PRESENT IN var_map THEN  
                        CALL THE add_term METHOD OF THE LAST ELEMENT IN output WITH A NEW Term WITH coefficient one AND variables AS A LIST CONTAINING token  
                    ELSE  
                        CALL THE add_term METHOD OF THE LAST ELEMENT IN output WITH A NEW Term WITH coefficient one AND AN EMPTY LIST FOR variables  
                    END IF  
                ELSE  
                    CALL THE add_term METHOD OF THE LAST ELEMENT IN output WITH A NEW Term WITH coefficient coef AND AN EMPTY LIST FOR variables  
                END IF  
            ELSE IF token EQUALS the STRING LEFT PARENTHESIS THEN  
                APPEND token TO operators  
            ELSE IF token EQUALS the STRING RIGHT PARENTHESIS THEN  
                WHILE operators IS NOT EMPTY AND the LAST ELEMENT OF operators NOT EQUAL TO the STRING LEFT PARENTHESIS  
                    CALL apply_operator()  
                END WHILE  
                REMOVE the LAST ELEMENT OF operators WHICH SHOULD BE the STRING LEFT PARENTHESIS  
            ELSE IF token IS IN THE LIST CONTAINING the STRING PLUS MINUS ASTERISK THEN  
                WHILE operators IS NOT EMPTY AND the LAST ELEMENT OF operators NOT EQUAL TO the STRING LEFT PARENTHESIS AND (token IS IN the LIST CONTAINING the STRING PLUS MINUS OR the LAST ELEMENT OF operators EQUALS the STRING ASTERISK)  
                    CALL apply_operator()  
                END WHILE  
                APPEND token TO operators  
            END IF  
            INCREMENT i BY one  
        END WHILE  
  
        WHILE operators IS NOT EMPTY  
            CALL apply_operator()  
        END WHILE  
  
        SET simplified_terms TO THE RESULT OF CALLING simplify() ON THE FIRST ELEMENT OF output  
        SET result_list TO an EMPTY LIST  
        FOR each term IN simplified_terms  
            IF term.variables IS NOT EMPTY THEN  
                SET term_string TO the STRING FORMED BY CONCATENATING THE STRING REPRESENTATION OF term.coefficient WITH the WORD 'ASTERISK' AND THE STRING FORMED BY JOINING the ELEMENTS OF term.variables WITH the WORD 'ASTERISK'  
                APPEND term_string TO result_list  
            ELSE  
                APPEND the STRING REPRESENTATION OF term.coefficient TO result_list  
            END IF  
        END FOR  
        RETURN result_list  
    END FUNCTION  
END CLASS