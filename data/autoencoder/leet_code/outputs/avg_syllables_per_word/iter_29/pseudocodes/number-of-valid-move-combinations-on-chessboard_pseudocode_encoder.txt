CLASS Solution  
    FUNCTION countCombinations(pieces, positions)  
        SET directions TO a mapping from piece type to list of direction pairs as follows  
            rook MAPPED TO list of pairs each pair consisting of one element in the first position being one or minus one or zero and the second element zero or minus one representing vertical and horizontal directions  
            queen MAPPED TO list of pairs each pair consisting of combinations of one zero minus one for first and second positions representing all eight directions including diagonals  
            bishop MAPPED TO list of pairs each pair consisting of one or minus one in both first and second positions representing four diagonal directions  
        
        SET positions TO new list constructed by FOR each row and column IN input positions  
            SET row MINUS one as new row value  
            SET column MINUS one as new column value  
            COLLECT pair consisting of new row value and new column value  
        END FOR  
        
        FUNCTION get_destinations(start, piece_type)  
            SET r TO the first element of start  
            SET c TO the second element of start  
            SET dests TO a list containing start position as the first element  
            FOR each direction_pair IN directions AT key piece_type  
                SET dr TO the first element of direction_pair  
                SET dc TO the second element of direction_pair  
                SET nr TO r PLUS dr  
                SET nc TO c PLUS dc  
                WHILE nr GREATER THAN OR EQUAL TO zero AND nr LESS THAN eight AND nc GREATER THAN OR EQUAL TO zero AND nc LESS THAN eight  
                    APPEND pair consisting of nr and nc TO dests  
                    INCREMENT nr BY dr  
                    INCREMENT nc BY dc  
                END WHILE  
            END FOR  
            RETURN dests  
        END FUNCTION  
        
        SET all_destinations TO new list constructed by FOR each pos and piece IN correspondence from positions and pieces  
            COLLECT get_destinations with pos and piece  
        END FOR  
        
        FUNCTION is_valid_combination(combination)  
            SET pos TO a new list copying positions  
            SET n TO the length OF pos  
            WHILE true  
                IF the length OF the set constructed from pos LESS THAN n THEN  
                    RETURN false  
                END IF  
                
                SET all_reached TO true  
                FOR i FROM zero TO n MINUS one  
                    IF element at position i of pos EQUALS element at position i of combination THEN  
                        CONTINUE TO next iteration  
                    END IF  
                    SET all_reached TO false  
                    SET r TO element at position zero of element at position i of pos  
                    SET c TO element at position one of element at position i of pos  
                    IF element at position zero of element at position i of combination GREATER THAN r THEN  
                        SET dr TO one  
                    ELSE IF element at position zero of element at position i of combination LESS THAN r THEN  
                        SET dr TO minus one  
                    ELSE  
                        SET dr TO zero  
                    END IF  
                    IF element at position one of element at position i of combination GREATER THAN c THEN  
                        SET dc TO one  
                    ELSE IF element at position one of element at position i of combination LESS THAN c THEN  
                        SET dc TO minus one  
                    ELSE  
                        SET dc TO zero  
                    END IF  
                    SET element at position i of pos TO pair consisting of r PLUS dr and c PLUS dc  
                END FOR  
                
                IF all_reached THEN  
                    RETURN true  
                END IF  
            END WHILE  
        END FUNCTION  
        
        SET valid_count TO zero  
        FOR each combination IN the cartesian product of all_destinations  
            IF is_valid_combination with combination THEN  
                INCREMENT valid_count BY one  
            END IF  
        END FOR  
        
        RETURN valid_count  
    END FUNCTION  
END CLASS