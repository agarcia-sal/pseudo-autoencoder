CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR index FROM zero TO n MINUS one  
            IF element at position index of group EQUALS negative one  
                SET element at position index of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        SET group_items TO a new empty mapping from group identifiers to a list of item indices  
        SET group_graph TO a new empty mapping from group identifiers to a list of group identifiers  
        SET item_graph TO a new empty mapping from item indices to a list of item indices  
        SET item_in_degree TO a list of length n filled with zero  
        SET group_in_degree TO a list of length m filled with zero  
        
        FOR index FROM zero TO n MINUS one  
            APPEND index TO the list in group_items at key element at position index of group  
        END FOR  
        
        FOR index FROM zero TO n MINUS one  
            FOR each element before IN element at position index of beforeItems  
                IF element at position before of group EQUALS element at position index of group  
                    APPEND index TO the list in item_graph at key before  
                    INCREMENT element at position index of item_in_degree BY one  
                ELSE  
                    APPEND element at position index of group TO the list in group_graph at key element at position before of group  
                    INCREMENT element at position element at position index of group of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET queue TO a new deque containing each element in items WHERE element at position element in in_degree EQUALS zero  
            SET result TO an empty list  
            WHILE queue is not empty  
                SET u TO the element removed from the left end of queue  
                APPEND u TO result  
                FOR each element v IN the list at key u of graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO queue  
                    END IF  
                END FOR  
            END WHILE  
            IF the LENGTH OF result EQUALS the LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN an empty list  
            END IF  
        END FUNCTION  
        
        SET sorted_within_groups TO an empty list  
        FOR each items_list IN the values of group_items  
            SET sorted_items TO the result of calling topological_sort with arguments item_graph item_in_degree items_list  
            IF the LENGTH OF sorted_items EQUALS zero  
                RETURN an empty list  
            END IF  
            APPEND each element of sorted_items TO sorted_within_groups  
        END FOR  
        
        SET sorted_groups TO the result of calling topological_sort with arguments group_graph group_in_degree list FROM zero TO m MINUS one  
        IF the LENGTH OF sorted_groups EQUALS zero  
            RETURN an empty list  
        END IF  
        
        SET group_to_items_map TO a new empty mapping from group identifiers to a list of item indices  
        FOR each item IN sorted_within_groups  
            APPEND item TO the list in group_to_items_map at key element at position item of group  
        END FOR  
        
        SET result TO an empty list  
        FOR each group_id IN sorted_groups  
            APPEND each element of the list at key group_id of group_to_items_map TO result  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS