CLASS Solution  
    FUNCTION countOfAtoms(formula)  
        FUNCTION parse(segment)  
            SET atom_count TO a new empty mapping with default zero integers  
            SET elements TO list of pairs of uppercase letter followed by zero or more lowercase letters and zero or more digits found in segment  
            FOR each element and count IN elements  
                IF count is empty  
                    INCREMENT atom_count at element BY one  
                ELSE  
                    INCREMENT atom_count at element BY integer conversion of count  
                END IF  
            END FOR  
            RETURN atom_count  
        END FUNCTION  

        FUNCTION multiply_counts(counts, multiplier)  
            FOR each element IN counts  
                SET counts at element TO counts at element MULTIPLIED BY multiplier  
            END FOR  
            RETURN counts  
        END FUNCTION  

        SET stack TO a list containing a new empty mapping with default zero integers  
        SET i TO zero  
        WHILE i LESS THAN the length of formula  
            IF character at position i OF formula EQUALS open parenthesis  
                APPEND a new empty mapping with default zero integers TO stack  
                INCREMENT i BY one  
            ELSE IF character at position i OF formula EQUALS close parenthesis  
                SET segment_count TO a new empty mapping with default zero integers  
                SET j TO i PLUS one  
                WHILE j LESS THAN the length of formula AND character at position j OF formula IS a digit  
                    INCREMENT j BY one  
                END WHILE  
                IF j GREATER THAN i PLUS one  
                    SET multiplier TO integer conversion of substring from position i PLUS one TO position j OF formula  
                ELSE  
                    SET multiplier TO one  
                END IF  
                SET segment_count TO multiply_counts(stack POP last element, multiplier)  
                FOR each element IN segment_count  
                    INCREMENT stack last element at element BY segment_count at element  
                END FOR  
                SET i TO j  
            ELSE  
                SET j TO i PLUS one  
                WHILE j LESS THAN the length of formula AND (character at position j OF formula IS lowercase letter OR character at position j OF formula IS digit)  
                    INCREMENT j BY one  
                END WHILE  
                SET segment_count TO parse(substring from position i TO position j OF formula)  
                FOR each element IN segment_count  
                    INCREMENT stack last element at element BY segment_count at element  
                END FOR  
                SET i TO j  
            END IF  
        END WHILE  

        SET final_count TO stack POP last element  
        SET result TO empty string  
        FOR each element IN the sorted keys of final_count  
            APPEND element TO result  
            IF final_count at element GREATER THAN one  
                APPEND string conversion of final_count at element TO result  
            END IF  
        END FOR  
        RETURN result  
    END FUNCTION  
END CLASS