CLASS Solution  
    FUNCTION shortestPathAllKeys(grid)  
        SET directions TO list of pairs zero one comma zero minus one comma one zero comma minus one zero  
        SET m TO the LENGTH OF grid  
        SET n TO the LENGTH OF element at position zero OF grid  
        SET start TO none  
        SET num_keys TO zero  
        FOR i FROM zero TO m MINUS one  
            FOR j FROM zero TO n MINUS one  
                IF element at position i OF grid AT position j EQUALS at symbol  
                    SET start TO pair of i comma j  
                ELSE IF character at position j OF element at position i OF grid IS lowercase  
                    INCREMENT num_keys BY one  
                END IF  
            END FOR  
        END FOR  
        INITIALIZE queue AS an empty double ended queue  
        ADD tuple of element zero of start comma element one of start comma zero comma zero TO queue  
        INITIALIZE visited AS an empty set  
        ADD tuple of element zero of start comma element one of start comma zero TO visited  
        WHILE queue is not empty  
            REMOVE the leftmost element FROM queue AND ASSIGN TO variables x comma y comma keys comma steps  
            FOR each pair dx comma dy IN directions  
                SET nx TO x PLUS dx  
                SET ny TO y PLUS dy  
                IF nx IS GREATER THAN OR EQUAL TO zero AND nx IS LESS THAN m AND ny IS GREATER THAN OR EQUAL TO zero AND ny IS LESS THAN n  
                    SET cell TO element at position nx OF grid AT position ny  
                    IF cell EQUALS the character hash  
                        CONTINUE  
                    END IF  
                    IF cell IS uppercase  
                        SET key_needed TO one SHIFTED LEFT BY the difference of the ASCII code of lowercase of cell MINUS ASCII code of character a  
                        IF bitwise AND of keys AND key_needed EQUALS zero  
                            CONTINUE  
                        END IF  
                    END IF  
                    IF cell IS lowercase  
                        SET new_keys TO bitwise OR of keys AND one SHIFTED LEFT BY the difference of the ASCII code of cell MINUS ASCII code of character a  
                        IF new_keys EQUALS one SHIFTED LEFT BY num_keys MINUS one  
                            RETURN steps PLUS one  
                        END IF  
                    ELSE  
                        SET new_keys TO keys  
                    END IF  
                    IF tuple of nx comma ny comma new_keys IS NOT IN visited  
                        ADD tuple of nx comma ny comma new_keys TO visited  
                        ADD tuple of nx comma ny comma new_keys comma steps PLUS one TO queue  
                    END IF  
                END IF  
            END FOR  
        END WHILE  
        RETURN minus one  
    END FUNCTION  
END CLASS