CLASS Solution  
    FUNCTION removeBoxes(boxes)  
        FUNCTION dp(l, r, k, memo)  
            IF l GREATER THAN r  
                RETURN zero  
            END IF  
            IF memo CONTAINS key composed of l AND r AND k  
                RETURN value FROM memo FOR key composed of l AND r AND k  
            END IF  
            WHILE r GREATER THAN l AND element at position r OF boxes EQUALS element at position r MINUS one OF boxes  
                DECREMENT r BY one  
                INCREMENT k BY one  
            END WHILE  
            SET res TO dp CALL WITH arguments l AND r MINUS one AND zero AND memo PLUS result of k PLUS one MULTIPLIED BY k PLUS one  
            FOR i FROM l TO r MINUS one  
                IF element at position i OF boxes EQUALS element at position r OF boxes  
                    SET candidate TO dp CALL WITH arguments l AND i AND k PLUS one AND memo PLUS dp CALL WITH arguments i PLUS one AND r MINUS one AND zero AND memo  
                    IF candidate GREATER THAN res  
                        SET res TO candidate  
                    END IF  
                END IF  
            END FOR  
            ASSIGN memo AT key composed of l AND r AND k TO res  
            RETURN res  
        END FUNCTION  
        RETURN dp CALL WITH arguments zero AND length of boxes MINUS one AND zero AND empty collection  
    END FUNCTION  
END CLASS