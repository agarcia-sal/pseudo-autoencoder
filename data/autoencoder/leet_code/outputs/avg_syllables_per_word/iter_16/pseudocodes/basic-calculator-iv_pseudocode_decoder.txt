CLASS Term  
    FUNCTION __init__(self, coefficient, variables)  
        SET self.coefficient TO coefficient  
        SET self.variables TO variables  
    END FUNCTION  

    FUNCTION __lt__(self, other)  
        IF the LENGTH OF self.variables IS NOT EQUAL TO the LENGTH OF other.variables THEN  
            RETURN the LENGTH OF self.variables IS GREATER THAN the LENGTH OF other.variables  
        END IF  
        RETURN the CONCATENATION OF self.variables WITH ASTERISK AS SEPARATOR IS LESS THAN the CONCATENATION OF other.variables WITH ASTERISK AS SEPARATOR  
    END FUNCTION  

    FUNCTION __repr__(self)  
        IF the LENGTH OF self.variables IS EQUAL TO zero THEN  
            RETURN the STRING REPRESENTATION OF self.coefficient  
        END IF  
        RETURN the STRING REPRESENTATION OF self.coefficient CONCATENATED WITH ASTERISK CONCATENATED WITH the CONCATENATION OF self.variables WITH ASTERISK AS SEPARATOR  
    END FUNCTION  
END CLASS  

CLASS Expression  
    FUNCTION __init__(self)  
        SET self.terms TO a DEFAULT DICTIONARY OF integer values  
    END FUNCTION  

    FUNCTION add_term(self, term)  
        SET key TO the TUPLE OF the SORTED list of term.variables  
        INCREMENT the VALUE ASSOCIATED WITH key IN self.terms BY term.coefficient  
    END FUNCTION  

    FUNCTION multiply(self, other)  
        SET result TO a NEW instance OF Expression  
        FOR each vars1 AND coeff1 IN the ITEMS OF self.terms  
            FOR each vars2 AND coeff2 IN the ITEMS OF other.terms  
                SET combined_vars TO the SORTED list OF the concatenation OF vars1 AND vars2  
                CALL result.add_term WITH a NEW Term HAVING coefficient AS coeff1 MULTIPLIED BY coeff2 AND variables AS combined_vars  
            END FOR  
        END FOR  
        RETURN result  
    END FUNCTION  

    FUNCTION add(self, other)  
        FOR each vars AND coeff IN the ITEMS OF other.terms  
            CALL self.add_term WITH a NEW Term HAVING coefficient AS coeff AND variables AS the LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  

    FUNCTION subtract(self, other)  
        FOR each vars AND coeff IN the ITEMS OF other.terms  
            CALL self.add_term WITH a NEW Term HAVING coefficient AS the NEGATIVE OF coeff AND variables AS the LIST OF vars  
        END FOR  
        RETURN self  
    END FUNCTION  

    FUNCTION evaluate(self, var_map)  
        SET result TO a NEW instance OF Expression  
        FOR each vars AND coeff IN the ITEMS OF self.terms  
            SET new_vars TO an EMPTY list  
            FOR each var IN vars  
                IF var IS IN var_map THEN  
                    APPEND the STRING REPRESENTATION OF the VALUE ASSOCIATED WITH var IN var_map TO new_vars  
                ELSE  
                    APPEND var TO new_vars  
                END IF  
            END FOR  
            IF new_vars IS NOT empty THEN  
                SET new_coeff TO the EVALUATION OF the CONCATENATION OF new_vars  
            ELSE  
                SET new_coeff TO one  
            END IF  
            CALL result.add_term WITH a NEW Term HAVING coefficient AS coeff MULTIPLIED BY new_coeff AND variables AS an EMPTY list  
        END FOR  
        RETURN result  
    END FUNCTION  

    FUNCTION simplify(self)  
        SET simplified_terms TO a LIST OF Term INSTANCES CREATED FROM each key AND coefficient IN self.terms WHERE coefficient IS NOT zero  
        SORT simplified_terms USING THE __lt__ FUNCTION OF Term  
        RETURN simplified_terms  
    END FUNCTION  

    FUNCTION __repr__(self)  
        SET simplified_terms TO self.simplify()  
        RETURN the STRING THAT JOIN each STRING REPRESENTATION OF term IN simplified_terms WITH A PLUS SIGN AS SEPARATOR  
    END FUNCTION  
END CLASS  

CLASS Solution  
    FUNCTION basicCalculatorIV(self, expression, evalvars, evalints)  
        SET var_map TO a DICTIONARY CREATED FROM PAIRING each element IN evalvars WITH the CORRESPONDING element IN evalints  
        SET tokens TO the LIST OF substrings FROM expression THAT MATCH the PATTERN REPRESENTING parentheses plus plus minus multiply digits or word characters  
        SET output TO an EMPTY list  
        SET operators TO an EMPTY list  

        FUNCTION apply_operator()  
            SET right TO the LAST ELEMENT OF output REMOVED  
            SET left TO the LAST ELEMENT OF output REMOVED  
            SET op TO the LAST ELEMENT OF operators REMOVED  
            IF op IS the PLUS SIGN THEN  
                APPEND to output the RESULT OF calling left.add WITH right  
            ELSE IF op IS the MINUS SIGN THEN  
                APPEND to output the RESULT OF calling left.subtract WITH right  
            ELSE IF op IS the ASTERISK THEN  
                APPEND to output the RESULT OF calling left.multiply WITH right  
            END IF  
        END FUNCTION  

        SET i TO zero  
        WHILE i IS LESS THAN the LENGTH OF tokens  
            SET token TO the ELEMENT AT position i OF tokens  
            IF token CONSISTS ONLY OF digits THEN  
                APPEND a NEW Expression INSTANCE TO output  
                CALL the add_term FUNCTION OF the LAST ELEMENT OF output WITH a NEW Term HAVING coefficient AS the INTEGER VALUE OF token AND variables AS an EMPTY list  
            ELSE IF token CONSISTS ONLY OF alphabetic characters THEN  
                APPEND a NEW Expression INSTANCE TO output  
                SET coef TO the VALUE ASSOCIATED WITH token IN var_map OR one IF token IS NOT PRESENT  
                IF coef IS EQUAL TO one THEN  
                    IF token IS NOT PRESENT IN var_map THEN  
                        CALL the add_term FUNCTION OF the LAST ELEMENT OF output WITH a NEW Term HAVING coefficient AS one AND variables AS a LIST CONTAINING token  
                    ELSE  
                        CALL the add_term FUNCTION OF the LAST ELEMENT OF output WITH a NEW Term HAVING coefficient AS one AND variables AS an EMPTY list  
                    END IF  
                ELSE  
                    CALL the add_term FUNCTION OF the LAST ELEMENT OF output WITH a NEW Term HAVING coefficient AS coef AND variables AS an EMPTY list  
                END IF  
            ELSE IF token IS an OPENING PARENTHESIS THEN  
                APPEND token TO operators  
            ELSE IF token IS a CLOSING PARENTHESIS THEN  
                WHILE operators IS NOT empty AND the LAST ELEMENT OF operators IS NOT an OPENING PARENTHESIS  
                    CALL apply_operator()  
                END WHILE  
                REMOVE the LAST ELEMENT FROM operators  
            ELSE IF token IS one OF the PLUS SIGN MINUS SIGN OR ASTERISK THEN  
                WHILE operators IS NOT empty AND the LAST ELEMENT OF operators IS NOT an OPENING PARENTHESIS AND (token IS the PLUS SIGN OR token IS the MINUS SIGN OR the LAST ELEMENT OF operators IS the ASTERISK)  
                    CALL apply_operator()  
                END WHILE  
                APPEND token TO operators  
            END IF  
            INCREMENT i BY one  
        END WHILE  

        WHILE operators IS NOT empty  
            CALL apply_operator()  
        END WHILE  

        SET simplified_terms TO the RESULT OF calling simplify ON the FIRST ELEMENT OF output  
        SET result_strings TO an EMPTY list  
        FOR each term IN simplified_terms  
            IF term.variables IS empty THEN  
                APPEND the STRING REPRESENTATION OF term.coefficient TO result_strings  
            ELSE  
                APPEND the STRING REPRESENTATION OF term.coefficient CONCATENATED WITH ASTERISK CONCATENATED WITH the CONCATENATION OF term.variables WITH ASTERISK AS SEPARATOR TO result_strings  
            END IF  
        END FOR  
        RETURN result_strings  
    END FUNCTION  
END CLASS