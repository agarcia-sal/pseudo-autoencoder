CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR index FROM zero TO n MINUS one  
            IF element at position index of group EQUALS negative one  
                SET element at position index of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
          
        ASSIGN group_items TO a new mapping FROM keys TO empty lists  
        ASSIGN group_graph TO a new mapping FROM keys TO empty lists  
        ASSIGN item_graph TO a new mapping FROM keys TO empty lists  
        SET item_in_degree TO a list of zeros WITH length n  
        SET group_in_degree TO a list of zeros WITH length m  
          
        FOR index FROM zero TO n MINUS one  
            APPEND index TO the list associated WITH key element at position index of group IN group_items  
        END FOR  
          
        FOR index FROM zero TO n MINUS one  
            FOR each before_element IN element at position index of beforeItems  
                IF element at position before_element of group EQUALS element at position index of group  
                    APPEND index TO the list associated WITH key before_element IN item_graph  
                    INCREMENT element at position index of item_in_degree BY one  
                ELSE  
                    APPEND element at position index of group TO the list associated WITH key element at position before_element of group IN group_graph  
                    INCREMENT element at position element at position index of group of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
          
        FUNCTION topological_sort(graph, in_degree, items)  
            ASSIGN q TO a new empty double-ended queue  
            FOR each item IN items  
                IF element at position item of in_degree EQUALS zero  
                    APPEND item TO q  
                END IF  
            END FOR  
            ASSIGN result TO an empty list  
            WHILE q is not empty  
                REMOVE the element from the front of q AND ASSIGN it TO u  
                APPEND u TO result  
                FOR each v IN element at position u of graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO q  
                    END IF  
                END FOR  
            END WHILE  
            IF the LENGTH OF result EQUALS the LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN an empty list  
            END IF  
        END FUNCTION  
          
        ASSIGN sorted_within_groups TO an empty list  
        FOR each items IN the values of group_items  
            ASSIGN sorted_items TO the result of topological_sort with arguments item_graph, item_in_degree, and items  
            IF the LENGTH OF sorted_items EQUALS zero  
                RETURN an empty list  
            END IF  
            EXTEND sorted_within_groups BY elements of sorted_items  
        END FOR  
          
        ASSIGN sorted_groups TO the result of topological_sort with arguments group_graph, group_in_degree, and the list of integers FROM zero TO m MINUS one  
        IF the LENGTH OF sorted_groups EQUALS zero  
            RETURN an empty list  
        END IF  
          
        ASSIGN group_to_items_map TO a new mapping FROM keys TO empty lists  
        FOR each item IN sorted_within_groups  
            APPEND item TO the list associated WITH key element at position item of group IN group_to_items_map  
        END FOR  
          
        ASSIGN result TO an empty list  
        FOR each group_id IN sorted_groups  
            EXTEND result BY the elements of the list associated WITH key group_id IN group_to_items_map  
        END FOR  
          
        RETURN result  
    END FUNCTION  
END CLASS