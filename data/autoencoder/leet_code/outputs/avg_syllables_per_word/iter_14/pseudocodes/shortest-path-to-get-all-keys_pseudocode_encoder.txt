CLASS Solution  
    FUNCTION shortestPathAllKeys(grid)  
        SET directions TO list of tuples zero one zero minus one one zero minus one zero  
        SET m TO the LENGTH OF grid  
        SET n TO the LENGTH OF element at position zero OF grid  
        SET start TO none  
        SET num_keys TO zero  
        
        FOR i FROM zero TO m MINUS one  
            FOR j FROM zero TO n MINUS one  
                IF element at position i OF grid EQUAL TO at symbol  
                    SET start TO tuple of i and j  
                ELSE IF element at position j OF element at position i OF grid IS A LOWERCASE LETTER  
                    INCREMENT num_keys BY one  
                END IF  
            END FOR  
        END FOR  
        
        SET queue TO a new empty deque with element tuple of element at position zero OF start element at position one OF start zero zero  
        SET visited TO an empty set  
        ADD tuple of element at position zero OF start element at position one OF start zero TO visited  
        
        WHILE queue IS NOT empty  
            REMOVE the element from the left OF queue AND ASSIGN TO x y keys steps  
            
            FOR each pair dx dy IN directions  
                SET nx TO x PLUS dx  
                SET ny TO y PLUS dy  
                
                IF nx IS GREATER THAN OR EQUAL TO zero AND nx IS LESS THAN m AND ny IS GREATER THAN OR EQUAL TO zero AND ny IS LESS THAN n  
                    SET cell TO element at position nx OF grid AT position ny  
                    
                    IF cell EQUAL TO hash symbol  
                        CONTINUE TO next iteration OF FOR  
                    END IF  
                    
                    IF cell IS AN UPPERCASE LETTER  
                        SET key_needed TO one LEFT SHIFTED BY the difference BETWEEN the UNICODE CODE POINT OF the lowercase form OF cell AND the UNICODE CODE POINT OF letter a  
                        IF bitwise AND BETWEEN keys AND key_needed EQUAL TO zero  
                            CONTINUE TO next iteration OF FOR  
                        END IF  
                    END IF  
                    
                    IF cell IS A LOWERCASE LETTER  
                        SET new_keys TO bitwise OR BETWEEN keys AND one LEFT SHIFTED BY the difference BETWEEN the UNICODE CODE POINT OF cell AND the UNICODE CODE POINT OF letter a  
                        IF new_keys EQUAL TO bitwise NOT of zero LEFT SHIFTED BY num_keys  
                            RETURN steps PLUS one  
                        END IF  
                    ELSE  
                        SET new_keys TO keys  
                    END IF  
                    
                    IF tuple of nx ny new_keys IS NOT IN visited  
                        ADD tuple of nx ny new_keys TO visited  
                        ADD tuple of nx ny new_keys steps PLUS one TO queue  
                    END IF  
                END IF  
            END FOR  
        END WHILE  
        
        RETURN minus one  
    END FUNCTION  
END CLASS