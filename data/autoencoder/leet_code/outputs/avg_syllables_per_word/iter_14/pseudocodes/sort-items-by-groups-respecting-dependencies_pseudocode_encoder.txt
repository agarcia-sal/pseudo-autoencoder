CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR index FROM zero TO n MINUS one  
            IF element at position index OF group EQUAL TO minus one  
                SET element at position index OF group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        SET group_items TO a new mapping from keys TO empty lists  
        SET group_graph TO a new mapping from keys TO empty lists  
        SET item_graph TO a new mapping from keys TO empty lists  
        SET item_in_degree TO a list of zeros of length n  
        SET group_in_degree TO a list of zeros of length m  
        
        FOR index FROM zero TO n MINUS one  
            APPEND index TO the list at key element at position index OF group IN group_items  
        END FOR  
        
        FOR index FROM zero TO n MINUS one  
            FOR each element before IN element at position index OF beforeItems  
                IF element at position before OF group EQUAL TO element at position index OF group  
                    APPEND index TO the list at key before IN item_graph  
                    INCREMENT element at position index OF item_in_degree BY one  
                ELSE  
                    APPEND element at position index OF group TO the list at key element at position before OF group IN group_graph  
                    INCREMENT element at position element at position index OF group OF group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET q TO a new double ended queue containing each element item IN items WHERE element at position item OF in_degree EQUAL TO zero  
            SET result_list TO an empty list  
            WHILE q IS NOT empty  
                SET element u TO the first element REMOVED FROM q  
                APPEND u TO result_list  
                FOR each element v IN the list at key u IN graph  
                    DECREMENT element at position v OF in_degree BY one  
                    IF element at position v OF in_degree EQUAL TO zero  
                        APPEND v TO q  
                    END IF  
                END FOR  
            END WHILE  
            IF the LENGTH OF result_list EQUAL TO the LENGTH OF items  
                RETURN result_list  
            ELSE  
                RETURN an empty list  
            END IF  
        END FUNCTION  
        
        SET sorted_within_groups TO an empty list  
        FOR each list items IN the collection of values IN group_items  
            SET sorted_items TO the value RETURNED BY the FUNCTION topological_sort WITH PARAMETERS item_graph, item_in_degree, items  
            IF the LENGTH OF sorted_items EQUAL TO zero  
                RETURN an empty list  
            END IF  
            EXTEND sorted_within_groups BY appending all elements FROM sorted_items  
        END FOR  
        
        SET sorted_groups TO the value RETURNED BY the FUNCTION topological_sort WITH PARAMETERS group_graph, group_in_degree, a list of integers FROM zero TO m MINUS one  
        IF the LENGTH OF sorted_groups EQUAL TO zero  
            RETURN an empty list  
        END IF  
        
        SET group_to_items_map TO a new mapping from keys TO empty lists  
        FOR each element item IN sorted_within_groups  
            APPEND item TO the list at key element at position item OF group IN group_to_items_map  
        END FOR  
        
        SET result TO an empty list  
        FOR each element group_element IN sorted_groups  
            EXTEND result BY appending all elements FROM the list at key group_element IN group_to_items_map  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS