CLASS Solution  
    FUNCTION countCombinations(pieces, positions)  
        SET directions TO dictionary with keys rook queen bishop and corresponding lists of direction pairs as follows  
            rook maps TO list of pairs containing one zero and one positive one or negative one in the first element  
            queen maps TO list of pairs containing one zero and one positive one or negative one in the first or second elements and pairs containing both elements as positive one or negative one  
            bishop maps TO list of pairs containing both elements as positive one or negative one  
        
        SET positions TO list obtained by taking each pair r c in positions and SETting each element TO its value MINUS one  
        
        FUNCTION get_destinations(start, piece_type)  
            SET r TO element at position zero of start  
            SET c TO element at position one of start  
            SET dests TO list containing start as the first element  
            FOR each pair dr dc IN directions at key piece_type  
                SET nr TO r PLUS dr  
                SET nc TO c PLUS dc  
                WHILE nr GREATER THAN OR EQUAL TO zero AND nr LESS THAN eight AND nc GREATER THAN OR EQUAL TO zero AND nc LESS THAN eight holds  
                    APPEND pair of nr nc TO dests  
                    SET nr TO nr PLUS dr  
                    SET nc TO nc PLUS dc  
                END WHILE  
            END FOR  
            RETURN dests  
        END FUNCTION  
        
        SET all_destinations TO list obtained by pairing each element pos from positions and each element piece from pieces and applying get_destinations function to pos and piece  
        
        FUNCTION is_valid_combination(combination)  
            SET pos TO copy of positions list  
            SET n TO LENGTH OF pos  
            WHILE true holds  
                SET unique_positions TO set of elements in pos  
                IF LENGTH OF unique_positions LESS THAN n THEN  
                    RETURN false  
                END IF  
                SET all_reached TO true  
                FOR each index i FROM zero TO n MINUS one  
                    IF element at position i of pos EQUALS element at position i of combination THEN  
                        CONTINUE to next iteration  
                    END IF  
                    SET all_reached TO false  
                    SET r TO element at position zero of element at position i of pos  
                    SET c TO element at position one of element at position i of pos  
                    SET target_r TO element at position zero of element at position i of combination  
                    SET target_c TO element at position one of element at position i of combination  
                    IF target_r GREATER THAN r THEN  
                        SET dr TO one  
                    ELSE IF target_r LESS THAN r THEN  
                        SET dr TO negative one  
                    ELSE  
                        SET dr TO zero  
                    END IF  
                    IF target_c GREATER THAN c THEN  
                        SET dc TO one  
                    ELSE IF target_c LESS THAN c THEN  
                        SET dc TO negative one  
                    ELSE  
                        SET dc TO zero  
                    END IF  
                    SET element at position i of pos TO pair of r PLUS dr and c PLUS dc  
                END FOR  
                IF all_reached THEN  
                    RETURN true  
                END IF  
            END WHILE  
        END FUNCTION  
        
        SET valid_count TO zero  
        FOR each combination IN cartesian product of all_destinations elements  
            IF is_valid_combination with parameter combination THEN  
                INCREMENT valid_count BY one  
            END IF  
        END FOR  
        
        RETURN valid_count  
    END FUNCTION  
END CLASS