CLASS Solution  
    FUNCTION maximumInvitations(favorite)  
        SET n TO LENGTH OF favorite  
        SET graph TO empty mapping from integer to list  
        SET in_degree TO list of zeros with length n  
        
        FOR i FROM 0 TO n MINUS 1  
            APPEND i TO graph AT key favorite at i  
            INCREMENT in_degree AT index favorite at i BY 1  
        
        SET mutual_chains TO 0  
        SET visited TO list of False with length n  
        
        FOR i FROM 0 TO n MINUS 1  
            IF favorite AT favorite at i EQUALS i AND i LESS THAN favorite at i THEN  
                SET a TO i  
                SET b TO favorite at i  
                SET chain_a TO CALL find_chain_length WITH a, graph, visited  
                SET chain_b TO CALL find_chain_length WITH b, graph, visited  
                INCREMENT mutual_chains BY chain_a PLUS chain_b  
        
        SET longest_cycle TO 0  
        SET visited TO list of False with length n  
        
        FOR i FROM 0 TO n MINUS 1  
            IF visited AT i IS False THEN  
                SET cycle_length TO CALL find_cycle_length WITH i, graph, visited, favorite  
                IF cycle_length GREATER THAN longest_cycle THEN  
                    SET longest_cycle TO cycle_length  
        
        RETURN the GREATER OF mutual_chains AND longest_cycle  
    END FUNCTION  
    
    FUNCTION find_chain_length(start, graph, visited)  
        SET length TO 0  
        SET queue TO collection with start as initial element  
        SET visited at start TO True  
        
        WHILE queue IS NOT EMPTY  
            SET current TO REMOVE first element FROM queue  
            FOR each neighbor IN graph at current  
                IF visited at neighbor IS False THEN  
                    SET visited at neighbor TO True  
                    ADD neighbor TO queue  
                    INCREMENT length BY 1  
        
        RETURN length  
    END FUNCTION  
    
    FUNCTION find_cycle_length(start, graph, visited, favorite)  
        IF visited at start IS True THEN  
            RETURN 0  
        
        SET stack TO empty list  
        SET current TO start  
        
        WHILE visited at current IS False  
            SET visited at current TO True  
            ADD current TO stack  
            SET current TO favorite at current  
        
        IF current NOT IN stack THEN  
            RETURN 0  
        
        SET cycle_start_index TO POSITION OF current IN stack  
        SET cycle_length TO LENGTH OF stack MINUS cycle_start_index  
        
        RETURN cycle_length  
    END FUNCTION  
END CLASS