CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR i FROM 0 TO n MINUS 1  
            IF group AT i EQUALS -1  
                SET group AT i TO m  
                INCREMENT m BY 1  
        
        SET group_items TO mapping from groups to list of items  
        SET group_graph TO mapping from groups to list of neighboring groups  
        SET item_graph TO mapping from items to list of neighboring items  
        SET item_in_degree TO list of zeros of length n  
        SET group_in_degree TO list of zeros of length m  
        
        FOR i FROM 0 TO n MINUS 1  
            APPEND i TO group_items AT group AT i  
        
        FOR i FROM 0 TO n MINUS 1  
            FOR before IN beforeItems AT i  
                IF group AT before EQUALS group AT i  
                    APPEND i TO item_graph AT before  
                    INCREMENT item_in_degree AT i BY 1  
                ELSE  
                    APPEND group AT i TO group_graph AT group AT before  
                    INCREMENT group_in_degree AT group AT i BY 1  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET q TO queue initialized with items WHERE in_degree AT item EQUALS 0  
            SET result TO empty list  
            WHILE q IS NOT EMPTY  
                SET u TO element dequeued from q  
                APPEND u TO result  
                FOR v IN graph AT u  
                    DECREMENT in_degree AT v BY 1  
                    IF in_degree AT v EQUALS 0  
                        ENQUEUE v TO q  
            IF LENGTH OF result EQUALS LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN empty list  
        
        SET sorted_within_groups TO empty list  
        FOR items IN group_items VALUES  
            SET sorted_items TO topological_sort(item_graph, item_in_degree, items)  
            IF sorted_items IS empty list  
                RETURN empty list  
            EXTEND sorted_within_groups BY sorted_items  
        
        SET sorted_groups TO topological_sort(group_graph, group_in_degree, list from 0 TO m MINUS 1)  
        IF sorted_groups IS empty list  
            RETURN empty list  
        
        SET group_to_items_map TO mapping from groups to list of items  
        FOR item IN sorted_within_groups  
            APPEND item TO group_to_items_map AT group AT item  
        
        SET result TO empty list  
        FOR group IN sorted_groups  
            EXTEND result BY group_to_items_map AT group  
        
        RETURN result  
    END FUNCTION  
END CLASS