CLASS Solution  
    FUNCTION shortestPathAllKeys(grid)  
        SET delta_coordinates TO [(1, 0), (-1, 0), (0, 1), (0, -1)]  
        SET height TO LENGTH OF grid  
        SET width TO LENGTH OF grid AT ZERO  
        SET initial_position TO null  
        SET total_keys TO 0  

        FUNCTION scan_positions(row_index)  
            IF row_index EQUALS height  
                RETURN  
            END IF  
            FUNCTION scan_columns(col_index)  
                IF col_index EQUALS width  
                    RETURN  
                END IF  
                SET cell_char TO grid AT row_index AT col_index  
                SWITCH cell_char  
                    CASE '@':  
                        SET initial_position TO (row_index, col_index)  
                    CASE 'a', 'b', 'c', 'd', 'e', 'f':  
                        INCREMENT total_keys BY 1  
                    DEFAULT:  
                        NO OPERATION  
                END SWITCH  
                scan_columns(col_index + 1)  
            END FUNCTION  
            scan_columns(0)  
            scan_positions(row_index + 1)  
        END FUNCTION  
        scan_positions(0)  

        SET exploration_queue TO a double ended queue containing (initial_position AT ZERO, initial_position AT ONE, 0, 0)  
        SET seen_states TO a set containing (initial_position AT ZERO, initial_position AT ONE, 0)  

        FUNCTION process_queue()  
            IF exploration_queue IS EMPTY  
                RETURN -1  
            END IF  
            SET current_x, current_y, collected_keys, distance_traveled TO POP FRONT OF exploration_queue  

            FOR EACH (delta_x, delta_y) IN delta_coordinates  
                SET new_x TO current_x + delta_x  
                SET new_y TO current_y + delta_y  
                IF 0 <= new_x < height AND 0 <= new_y < width  
                    SET grid_cell TO grid AT new_x AT new_y  
                    IF grid_cell EQUALS '#'  
                        CONTINUE  
                    END IF  
                    IF 'A' <= grid_cell <= 'F'  
                        SET required_key_mask TO 1 LEFT SHIFT (UNICODE OF LOWERCASE(grid_cell) MINUS UNICODE OF 'a')  
                        IF (collected_keys BITWISE AND required_key_mask) EQUALS 0  
                            CONTINUE  
                        END IF  
                    END IF  

                    IF 'a' <= grid_cell <= 'f'  
                        SET updated_keys TO collected_keys BITWISE OR (1 LEFT SHIFT (UNICODE OF grid_cell MINUS UNICODE OF 'a'))  
                        IF updated_keys EQUALS (1 LEFT SHIFT total_keys) - 1  
                            RETURN distance_traveled + 1  
                        END IF  
                    ELSE  
                        SET updated_keys TO collected_keys  
                    END IF  

                    IF (new_x, new_y, updated_keys) NOT IN seen_states  
                        ADD (new_x, new_y, updated_keys) TO seen_states  
                        ADD (new_x, new_y, updated_keys, distance_traveled + 1) TO exploration_queue  
                    END IF  
                END IF  
            END FOR  
            RETURN process_queue()  
        END FUNCTION  
        RETURN process_queue()  
    END FUNCTION  
END CLASS