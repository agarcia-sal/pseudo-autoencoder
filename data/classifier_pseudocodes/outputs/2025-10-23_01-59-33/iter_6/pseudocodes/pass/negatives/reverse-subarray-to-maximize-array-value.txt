```
n = len(nums)
if n == 2: return abs(nums[0] - nums[1])

initial = sum(abs(nums[i] - nums[i-1]) for i in 1..n-1)

max_gain = max(
  max(abs(nums[0] - nums[i]) - abs(nums[i] - nums[i-1]) for i in 1..n-1),
  max(abs(nums[n-1] - nums[i]) - abs(nums[i+1] - nums[i]) for i in 0..n-2)
)

min_pair = min(max(nums[i], nums[i+1]) for i in 0..n-2)
max_pair = max(min(nums[i], nums[i+1]) for i in 0..n-2)

general_gain = max(0, 2*(max_pair - min_pair))

return initial + max(max_gain, general_gain)
```