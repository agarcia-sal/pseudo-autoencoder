```
for i in 0..n-1: if group[i] == -1: group[i], m = m, m+1

group_items = map from group -> list of items
group_graph = map from group -> list of groups
item_graph = map from item -> list of items
item_in_degree = array[n] of 0
group_in_degree = array[m] of 0

for i in 0..n-1: group_items[group[i]].append(i)

for i in 0..n-1:
  for b in beforeItems[i]:
    if group[b] == group[i]:
      item_graph[b].append(i)
      item_in_degree[i] += 1
    else:
      group_graph[group[b]].append(group[i])
      group_in_degree[group[i]] += 1

function topo_sort(g, in_deg, elems):
  q = elems with in_deg == 0
  res = []
  while q not empty:
    u = q.pop front
    res.append(u)
    for v in g[u]:
      in_deg[v] -= 1
      if in_deg[v] == 0: q.append(v)
  return res if length(res) == length(elems) else []

sorted_within = []
for items in group_items.values():
  sorted_items = topo_sort(item_graph, item_in_degree, items)
  if sorted_items empty: return []
  sorted_within.extend(sorted_items)

sorted_groups = topo_sort(group_graph, group_in_degree, [0..m-1])
if sorted_groups empty: return []

grp_to_items = map group -> list
for item in sorted_within: grp_to_items[group[item]].append(item)

res = []
for g in sorted_groups: res.extend(grp_to_items[g])
return res
```