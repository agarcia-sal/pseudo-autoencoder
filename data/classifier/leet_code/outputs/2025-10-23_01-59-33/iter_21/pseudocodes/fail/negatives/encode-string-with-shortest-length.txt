```
encode(s):
  dp(i,j):
    sub = s[i..j], n = j - i + 1
    if n < 5: return sub
    shortest = sub
    for k in 1..n//2:
      if n % k == 0 and sub == sub[0..k-1] * (n//k):
        cand = (n//k) + "[" + dp(i,i+k-1) + "]"
        if len(cand) < len(shortest): shortest = cand
    for k in i..j-1:
      combined = dp(i,k) + dp(k+1,j)
      if len(combined) < len(shortest): shortest = combined
    return shortest
  return dp(0,len(s)-1)
```