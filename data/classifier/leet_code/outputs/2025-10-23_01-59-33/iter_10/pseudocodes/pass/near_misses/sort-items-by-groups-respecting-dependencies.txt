CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FUNCTION assign_groups(index)  
            IF index EQUALS n  
                RETURN m  
            ELSE  
                IF element at position index of group EQUALS minus one  
                    SET element at position index of group TO m  
                    RETURN assign_groups(index PLUS one) PLUS one  
                ELSE  
                    RETURN assign_groups(index PLUS one)  
                END IF  
            END IF  
        END FUNCTION  
        
        SET updated_m TO assign_groups(0)  
        SET group_items_map TO dictionary with default empty list values  
        SET group_dependency_graph TO dictionary with default empty list values  
        SET item_dependency_graph TO dictionary with default empty list values  
        SET item_in_deg TO list of zeros with length n  
        SET group_in_deg TO list of zeros with length updated_m  
        
        FUNCTION populate_group_items(counter)  
            IF counter EQUALS n  
                RETURN  
            ELSE  
                APPEND counter TO group_items_map[element at position counter of group]  
                populate_group_items(counter PLUS one)  
            END IF  
        END FUNCTION  
        
        CALL populate_group_items(0)  
        
        FOR current_item FROM 0 TO n MINUS one  
            FOR each prerequisite IN element at position current_item of beforeItems  
                SET current_group TO element at position current_item of group  
                SET prerequisite_group TO element at position prerequisite of group  
                IF current_group EQUALS prerequisite_group  
                    APPEND current_item TO item_dependency_graph[prerequisite]  
                    INCREMENT item_in_deg[current_item] BY one  
                ELSE  
                    APPEND current_group TO group_dependency_graph[prerequisite_group]  
                    INCREMENT group_in_deg[current_group] BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(dep_graph, in_degree_list, node_list)  
            SET zero_degree_nodes TO list derived from node_list FILTERED by elements whose in_degree_list value IS zero  
            SET processing_queue TO zero_degree_nodes  
            SET ordered_nodes TO empty list  
            
            FUNCTION process_queue()  
                IF processing_queue IS empty  
                    RETURN  
                ELSE  
                    SET current_node TO remove first element from processing_queue  
                    APPEND current_node TO ordered_nodes  
                    FOR each neighbor IN dep_graph[current_node]  
                        DECREMENT in_degree_list[neighbor] BY one  
                        IF in_degree_list[neighbor] EQUALS zero  
                            APPEND neighbor TO processing_queue  
                        END IF  
                    END FOR  
                    process_queue()  
                END IF  
            END FUNCTION  
            
            CALL process_queue()  
            
            IF LENGTH OF ordered_nodes EQUALS LENGTH OF node_list  
                RETURN ordered_nodes  
            ELSE  
                RETURN empty list  
            END IF  
        END FUNCTION  
        
        SET all_sorted_items TO empty list  
        FOR each group_key IN all keys of group_items_map  
            SET sorted_subset TO topological_sort(item_dependency_graph, item_in_deg, group_items_map[group_key])  
            IF LENGTH OF sorted_subset EQUALS zero  
                RETURN empty list  
            END IF  
            FOR each element IN sorted_subset  
                APPEND element TO all_sorted_items  
            END FOR  
        END FOR  
        
        SET sorted_group_order TO topological_sort(group_dependency_graph, group_in_deg, list FROM 0 TO updated_m MINUS one)  
        IF LENGTH OF sorted_group_order EQUALS zero  
            RETURN empty list  
        END IF  
        
        SET group_to_items_collection TO dictionary with default empty list values  
        FOR each elem IN all_sorted_items  
            APPEND elem TO group_to_items_collection[element at position elem of group]  
        END FOR  
        
        SET final_result_list TO empty list  
        FOR each ordered_group IN sorted_group_order  
            EXTEND final_result_list BY group_to_items_collection[ordered_group]  
        END FOR  
        
        RETURN final_result_list  
    END FUNCTION  
END CLASS