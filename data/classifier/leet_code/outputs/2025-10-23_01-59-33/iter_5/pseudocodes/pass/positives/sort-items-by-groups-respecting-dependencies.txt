CLASS Solution  
    FUNCTION sortItems(n, m, group, beforeItems)  
        FOR i FROM zero TO n MINUS one  
            IF element at position i of group EQUALS minus one  
                SET element at position i of group TO m  
                INCREMENT m BY one  
            END IF  
        END FOR  
        
        SET group_items TO a mapping from keys to empty lists  
        SET group_graph TO a mapping from keys to empty lists  
        SET item_graph TO a mapping from keys to empty lists  
        SET item_in_degree TO a list consisting of zero repeated n times  
        SET group_in_degree TO a list consisting of zero repeated m times  
        
        FOR i FROM zero TO n MINUS one  
            APPEND i TO list at key element at position i of group in group_items  
        END FOR  
        
        FOR i FROM zero TO n MINUS one  
            FOR each before_element IN element at position i of beforeItems  
                IF element at position before_element of group EQUALS element at position i of group  
                    APPEND i TO list at key before_element in item_graph  
                    INCREMENT element at position i of item_in_degree BY one  
                ELSE  
                    APPEND element at position i of group TO list at key element at position before_element of group in group_graph  
                    INCREMENT element at position element at position i of group of group_in_degree BY one  
                END IF  
            END FOR  
        END FOR  
        
        FUNCTION topological_sort(graph, in_degree, items)  
            SET queue TO a double-ended queue initialized with elements from items WHERE element at position element of in_degree EQUALS zero  
            SET result TO empty list  
            
            WHILE queue is not empty  
                REMOVE element from front of queue and assign to u  
                APPEND u TO result  
                FOR each v IN list at key u in graph  
                    DECREMENT element at position v of in_degree BY one  
                    IF element at position v of in_degree EQUALS zero  
                        APPEND v TO queue  
                    END IF  
                END FOR  
            END WHILE  
            
            IF LENGTH OF result EQUALS LENGTH OF items  
                RETURN result  
            ELSE  
                RETURN empty list  
            END IF  
        END FUNCTION  
        
        SET sorted_within_groups TO empty list  
        FOR each items_list IN all values of group_items  
            SET sorted_items TO topological_sort(item_graph, item_in_degree, items_list)  
            IF LENGTH OF sorted_items EQUALS zero  
                RETURN empty list  
            END IF  
            EXTEND sorted_within_groups BY sorted_items  
        END FOR  
        
        SET sorted_groups TO topological_sort(group_graph, group_in_degree, list of elements from zero TO m MINUS one)  
        IF LENGTH OF sorted_groups EQUALS zero  
            RETURN empty list  
        END IF  
        
        SET group_to_items_map TO a mapping from keys to empty lists  
        FOR each item IN sorted_within_groups  
            APPEND item TO list at key element at position item of group in group_to_items_map  
        END FOR  
        
        SET result TO empty list  
        FOR each grp IN sorted_groups  
            EXTEND result BY list at key grp in group_to_items_map  
        END FOR  
        
        RETURN result  
    END FUNCTION  
END CLASS