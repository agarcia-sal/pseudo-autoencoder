CLASS Solution  
    FUNCTION wordSquares(words)  
        DECLARE registry AS a dictionary mapping string keys to sets of strings  
        
        PROCEDURE registerPrefixes(w)  
            VAR pos := 0  
            WHILE pos < LENGTH(w) LOOP  
                VAR pfx := SUBSTRING(w, 0, pos)  
                IF registry CONTAINS pfx THEN  
                    registry[pfx] := registry[pfx] UNION {w}  
                ELSE  
                    registry[pfx] := {w}  
                END IF  
                pos := pos + 1  
            END LOOP  
        END PROCEDURE  
        
        FOR EACH w IN words DO  
            CALL registerPrefixes(w)  
        END FOR  
        
        VAR solutions := []  
        
        PROCEDURE recurseBuild(partialSquare)  
            IF LENGTH(partialSquare) = LENGTH(words[0]) THEN  
                solutions := solutions + [partialSquare]  
                RETURN  
            END IF  
            
            VAR desiredPrefix := ""  
            FOR i FROM 0 TO LENGTH(partialSquare) - 1 DO  
                desiredPrefix := desiredPrefix + partialSquare[i][LENGTH(partialSquare)]  
            END FOR  
            
            IF registry CONTAINS desiredPrefix THEN  
                FOR EACH candidateWord IN registry[desiredPrefix] DO  
                    CALL recurseBuild(partialSquare + [candidateWord])  
                END FOR  
            END IF  
        END PROCEDURE  
        
        FOR EACH seedWord IN words DO  
            CALL recurseBuild([seedWord])  
        END FOR  
        
        RETURN solutions  
    END FUNCTION  
END CLASS